<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>tanjiawen</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/blog/icon.png">
    <meta name="description" content="Just do it">
    
    <link rel="preload" href="/blog/assets/css/0.styles.fb68c3ca.css" as="style"><link rel="preload" href="/blog/assets/js/app.a9945600.js" as="script"><link rel="preload" href="/blog/assets/js/2.3af135cd.js" as="script"><link rel="preload" href="/blog/assets/js/149.c3b4d241.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.8284ffc7.js"><link rel="prefetch" href="/blog/assets/js/100.f43ee495.js"><link rel="prefetch" href="/blog/assets/js/101.af588b87.js"><link rel="prefetch" href="/blog/assets/js/102.fceaf7cd.js"><link rel="prefetch" href="/blog/assets/js/103.237512b5.js"><link rel="prefetch" href="/blog/assets/js/104.5b0b5556.js"><link rel="prefetch" href="/blog/assets/js/105.377afdf9.js"><link rel="prefetch" href="/blog/assets/js/106.6c8faab0.js"><link rel="prefetch" href="/blog/assets/js/107.f05b17b2.js"><link rel="prefetch" href="/blog/assets/js/108.24380ae4.js"><link rel="prefetch" href="/blog/assets/js/109.4fc3aa4f.js"><link rel="prefetch" href="/blog/assets/js/11.9e763810.js"><link rel="prefetch" href="/blog/assets/js/110.9872b4b9.js"><link rel="prefetch" href="/blog/assets/js/111.8be8fde4.js"><link rel="prefetch" href="/blog/assets/js/112.9f21b37f.js"><link rel="prefetch" href="/blog/assets/js/113.5d6d8b94.js"><link rel="prefetch" href="/blog/assets/js/114.ae32905e.js"><link rel="prefetch" href="/blog/assets/js/115.6c90fdfc.js"><link rel="prefetch" href="/blog/assets/js/116.4c181179.js"><link rel="prefetch" href="/blog/assets/js/117.b775cf93.js"><link rel="prefetch" href="/blog/assets/js/118.1cc72273.js"><link rel="prefetch" href="/blog/assets/js/119.e1c025d6.js"><link rel="prefetch" href="/blog/assets/js/12.06a3d36d.js"><link rel="prefetch" href="/blog/assets/js/120.4932db4b.js"><link rel="prefetch" href="/blog/assets/js/121.276f05eb.js"><link rel="prefetch" href="/blog/assets/js/122.26d84809.js"><link rel="prefetch" href="/blog/assets/js/123.a1dcb4d5.js"><link rel="prefetch" href="/blog/assets/js/124.bc51e9ad.js"><link rel="prefetch" href="/blog/assets/js/125.f1c600f6.js"><link rel="prefetch" href="/blog/assets/js/126.4a939469.js"><link rel="prefetch" href="/blog/assets/js/127.de1057e9.js"><link rel="prefetch" href="/blog/assets/js/128.47b26a21.js"><link rel="prefetch" href="/blog/assets/js/129.375e29fe.js"><link rel="prefetch" href="/blog/assets/js/13.5f19c836.js"><link rel="prefetch" href="/blog/assets/js/130.2f5f1157.js"><link rel="prefetch" href="/blog/assets/js/131.41c79642.js"><link rel="prefetch" href="/blog/assets/js/132.bf263adf.js"><link rel="prefetch" href="/blog/assets/js/133.e2199dcd.js"><link rel="prefetch" href="/blog/assets/js/134.a8b03f50.js"><link rel="prefetch" href="/blog/assets/js/135.6ec46987.js"><link rel="prefetch" href="/blog/assets/js/136.8b3fdace.js"><link rel="prefetch" href="/blog/assets/js/137.a427c5c6.js"><link rel="prefetch" href="/blog/assets/js/138.1cf3e855.js"><link rel="prefetch" href="/blog/assets/js/139.63e6b0c6.js"><link rel="prefetch" href="/blog/assets/js/14.51a8431a.js"><link rel="prefetch" href="/blog/assets/js/140.9615b46c.js"><link rel="prefetch" href="/blog/assets/js/141.230b60ba.js"><link rel="prefetch" href="/blog/assets/js/142.8eda03ee.js"><link rel="prefetch" href="/blog/assets/js/143.c4d976f1.js"><link rel="prefetch" href="/blog/assets/js/144.699fc7ec.js"><link rel="prefetch" href="/blog/assets/js/145.e3ab15da.js"><link rel="prefetch" href="/blog/assets/js/146.08905a96.js"><link rel="prefetch" href="/blog/assets/js/147.09ca7dfc.js"><link rel="prefetch" href="/blog/assets/js/148.45af3dc5.js"><link rel="prefetch" href="/blog/assets/js/15.72a92a5e.js"><link rel="prefetch" href="/blog/assets/js/150.6b86563f.js"><link rel="prefetch" href="/blog/assets/js/151.804e4177.js"><link rel="prefetch" href="/blog/assets/js/152.70cc135c.js"><link rel="prefetch" href="/blog/assets/js/153.6de516b6.js"><link rel="prefetch" href="/blog/assets/js/154.c642c181.js"><link rel="prefetch" href="/blog/assets/js/155.b59c4d7f.js"><link rel="prefetch" href="/blog/assets/js/156.ee19c90e.js"><link rel="prefetch" href="/blog/assets/js/157.e249f132.js"><link rel="prefetch" href="/blog/assets/js/158.f49f881b.js"><link rel="prefetch" href="/blog/assets/js/159.ee57b260.js"><link rel="prefetch" href="/blog/assets/js/16.ef643ba6.js"><link rel="prefetch" href="/blog/assets/js/160.3f1f373b.js"><link rel="prefetch" href="/blog/assets/js/161.8f3bf814.js"><link rel="prefetch" href="/blog/assets/js/162.be1644a6.js"><link rel="prefetch" href="/blog/assets/js/163.54bfb0d9.js"><link rel="prefetch" href="/blog/assets/js/164.c7630457.js"><link rel="prefetch" href="/blog/assets/js/165.48921b01.js"><link rel="prefetch" href="/blog/assets/js/166.ff957762.js"><link rel="prefetch" href="/blog/assets/js/167.952152c7.js"><link rel="prefetch" href="/blog/assets/js/168.18858c2d.js"><link rel="prefetch" href="/blog/assets/js/169.cfa7b9d3.js"><link rel="prefetch" href="/blog/assets/js/17.a2ce8782.js"><link rel="prefetch" href="/blog/assets/js/170.2f675b22.js"><link rel="prefetch" href="/blog/assets/js/171.3a66756a.js"><link rel="prefetch" href="/blog/assets/js/172.842fd9e9.js"><link rel="prefetch" href="/blog/assets/js/173.5bba42f1.js"><link rel="prefetch" href="/blog/assets/js/174.b3b3ea12.js"><link rel="prefetch" href="/blog/assets/js/18.7f01d8ef.js"><link rel="prefetch" href="/blog/assets/js/19.e3513f33.js"><link rel="prefetch" href="/blog/assets/js/20.03616f12.js"><link rel="prefetch" href="/blog/assets/js/21.2298db57.js"><link rel="prefetch" href="/blog/assets/js/22.74c0e9e0.js"><link rel="prefetch" href="/blog/assets/js/23.f3fca169.js"><link rel="prefetch" href="/blog/assets/js/24.76042ebf.js"><link rel="prefetch" href="/blog/assets/js/25.565736de.js"><link rel="prefetch" href="/blog/assets/js/26.a780b1d1.js"><link rel="prefetch" href="/blog/assets/js/27.9508d923.js"><link rel="prefetch" href="/blog/assets/js/28.6d3a3926.js"><link rel="prefetch" href="/blog/assets/js/29.1d80c479.js"><link rel="prefetch" href="/blog/assets/js/3.8c172953.js"><link rel="prefetch" href="/blog/assets/js/30.34bf483b.js"><link rel="prefetch" href="/blog/assets/js/31.e416afee.js"><link rel="prefetch" href="/blog/assets/js/32.78191060.js"><link rel="prefetch" href="/blog/assets/js/33.787fa150.js"><link rel="prefetch" href="/blog/assets/js/34.83d3fa1e.js"><link rel="prefetch" href="/blog/assets/js/35.758f7354.js"><link rel="prefetch" href="/blog/assets/js/36.4fc20e4a.js"><link rel="prefetch" href="/blog/assets/js/37.516227a0.js"><link rel="prefetch" href="/blog/assets/js/38.984ec5bb.js"><link rel="prefetch" href="/blog/assets/js/39.6e70b5ca.js"><link rel="prefetch" href="/blog/assets/js/4.286f5b50.js"><link rel="prefetch" href="/blog/assets/js/40.3ce5d266.js"><link rel="prefetch" href="/blog/assets/js/41.04d9a371.js"><link rel="prefetch" href="/blog/assets/js/42.f9e63ded.js"><link rel="prefetch" href="/blog/assets/js/43.ac4d5aee.js"><link rel="prefetch" href="/blog/assets/js/44.1e8f4b25.js"><link rel="prefetch" href="/blog/assets/js/45.7b777d65.js"><link rel="prefetch" href="/blog/assets/js/46.96934414.js"><link rel="prefetch" href="/blog/assets/js/47.2406aee8.js"><link rel="prefetch" href="/blog/assets/js/48.371ab31c.js"><link rel="prefetch" href="/blog/assets/js/49.bd5be0a3.js"><link rel="prefetch" href="/blog/assets/js/5.967910cb.js"><link rel="prefetch" href="/blog/assets/js/50.3387825c.js"><link rel="prefetch" href="/blog/assets/js/51.9765871b.js"><link rel="prefetch" href="/blog/assets/js/52.eea392cb.js"><link rel="prefetch" href="/blog/assets/js/53.ee1c2a63.js"><link rel="prefetch" href="/blog/assets/js/54.6440a057.js"><link rel="prefetch" href="/blog/assets/js/55.fba17580.js"><link rel="prefetch" href="/blog/assets/js/56.ec7a617b.js"><link rel="prefetch" href="/blog/assets/js/57.a5b02e90.js"><link rel="prefetch" href="/blog/assets/js/58.acd13ae5.js"><link rel="prefetch" href="/blog/assets/js/59.63e4c77d.js"><link rel="prefetch" href="/blog/assets/js/6.95f5a1df.js"><link rel="prefetch" href="/blog/assets/js/60.059e8999.js"><link rel="prefetch" href="/blog/assets/js/61.3c8c64c6.js"><link rel="prefetch" href="/blog/assets/js/62.29f2d328.js"><link rel="prefetch" href="/blog/assets/js/63.fd04fdac.js"><link rel="prefetch" href="/blog/assets/js/64.3a515004.js"><link rel="prefetch" href="/blog/assets/js/65.cacaea7e.js"><link rel="prefetch" href="/blog/assets/js/66.ab62c848.js"><link rel="prefetch" href="/blog/assets/js/67.36d6f043.js"><link rel="prefetch" href="/blog/assets/js/68.ea171a47.js"><link rel="prefetch" href="/blog/assets/js/69.d81d52c7.js"><link rel="prefetch" href="/blog/assets/js/7.d1c12d08.js"><link rel="prefetch" href="/blog/assets/js/70.ed56051d.js"><link rel="prefetch" href="/blog/assets/js/71.8002c62d.js"><link rel="prefetch" href="/blog/assets/js/72.5415c4f8.js"><link rel="prefetch" href="/blog/assets/js/73.343c9e75.js"><link rel="prefetch" href="/blog/assets/js/74.540fa3f7.js"><link rel="prefetch" href="/blog/assets/js/75.517dd1ef.js"><link rel="prefetch" href="/blog/assets/js/76.2aec58c7.js"><link rel="prefetch" href="/blog/assets/js/77.22eb4605.js"><link rel="prefetch" href="/blog/assets/js/78.e8a10b94.js"><link rel="prefetch" href="/blog/assets/js/79.2026245e.js"><link rel="prefetch" href="/blog/assets/js/8.07533508.js"><link rel="prefetch" href="/blog/assets/js/80.47bf8af2.js"><link rel="prefetch" href="/blog/assets/js/81.85a9c4cc.js"><link rel="prefetch" href="/blog/assets/js/82.99464a5d.js"><link rel="prefetch" href="/blog/assets/js/83.89857466.js"><link rel="prefetch" href="/blog/assets/js/84.2535f1b2.js"><link rel="prefetch" href="/blog/assets/js/85.3fb68877.js"><link rel="prefetch" href="/blog/assets/js/86.4f401dab.js"><link rel="prefetch" href="/blog/assets/js/87.5eaeb89e.js"><link rel="prefetch" href="/blog/assets/js/88.77c09654.js"><link rel="prefetch" href="/blog/assets/js/89.3fca8870.js"><link rel="prefetch" href="/blog/assets/js/9.d0d2872d.js"><link rel="prefetch" href="/blog/assets/js/90.63d8c5d0.js"><link rel="prefetch" href="/blog/assets/js/91.5075603f.js"><link rel="prefetch" href="/blog/assets/js/92.63c5ea3b.js"><link rel="prefetch" href="/blog/assets/js/93.36e1c443.js"><link rel="prefetch" href="/blog/assets/js/94.af8b02f1.js"><link rel="prefetch" href="/blog/assets/js/95.cefba26c.js"><link rel="prefetch" href="/blog/assets/js/96.35a18ac0.js"><link rel="prefetch" href="/blog/assets/js/97.5a074780.js"><link rel="prefetch" href="/blog/assets/js/98.ef4e180d.js"><link rel="prefetch" href="/blog/assets/js/99.c3eb760b.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.fb68c3ca.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><img src="/blog/logo.jpg" alt="tanjiawen" class="logo"> <span class="site-name can-hide">tanjiawen</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/blog/website/" class="nav-link">
  网站推荐
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="面试题" class="dropdown-title"><span class="title">面试题</span> <span class="arrow down"></span></button> <button type="button" aria-label="面试题" class="mobile-dropdown-title"><span class="title">面试题</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://interview2.poetries.top/docs/base.html#%E4%B8%80%E3%80%81html%E3%80%81http%E3%80%81web%E7%BB%BC%E5%90%88%E9%97%AE%E9%A2%98" target="_blank" rel="noopener noreferrer" class="nav-link external">
  面试题1
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://wangtunan.github.io/blog/interview/#javascript%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86%E9%9D%A2%E8%AF%95%E9%A2%98" target="_blank" rel="noopener noreferrer" class="nav-link external">
  面试题2
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="书籍" class="dropdown-title"><span class="title">书籍</span> <span class="arrow down"></span></button> <button type="button" aria-label="书籍" class="mobile-dropdown-title"><span class="title">书籍</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          js
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/blog/books/js/es6/" class="nav-link">
  es6
</a></li></ul></li><li class="dropdown-item"><h4>
          web 3D
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="http://www.webgl3d.cn/WebGL/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  webgl
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-subitem"><a href="http://www.webgl3d.cn/Three.js/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  threejs
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></li><li class="dropdown-item"><!----> <a href="/blog/git/" class="nav-link">
  Git
</a></li><li class="dropdown-item"><!----> <a href="/blog/vite/" class="nav-link">
  vite
</a></li></ul></div></div><div class="nav-item"><a href="/blog/api/" class="nav-link">
  API
</a></div><div class="nav-item"><a href="/blog/node/base/01-环境搭建.html" class="nav-link">
  node
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Typescript" class="dropdown-title"><span class="title">Typescript</span> <span class="arrow down"></span></button> <button type="button" aria-label="Typescript" class="mobile-dropdown-title"><span class="title">Typescript</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/typescript/base.html" class="nav-link">
  基础
</a></li><li class="dropdown-item"><!----> <a href="/blog/typescript/challenge.html" class="nav-link">
  高级api
</a></li></ul></div></div><div class="nav-item"><a href="/blog/other/resource-analysis/vue2.html" class="nav-link">
  other
</a></div><div class="nav-item"><a href="https://github.com/tjw-javen/blog" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/blog/website/" class="nav-link">
  网站推荐
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="面试题" class="dropdown-title"><span class="title">面试题</span> <span class="arrow down"></span></button> <button type="button" aria-label="面试题" class="mobile-dropdown-title"><span class="title">面试题</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://interview2.poetries.top/docs/base.html#%E4%B8%80%E3%80%81html%E3%80%81http%E3%80%81web%E7%BB%BC%E5%90%88%E9%97%AE%E9%A2%98" target="_blank" rel="noopener noreferrer" class="nav-link external">
  面试题1
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://wangtunan.github.io/blog/interview/#javascript%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86%E9%9D%A2%E8%AF%95%E9%A2%98" target="_blank" rel="noopener noreferrer" class="nav-link external">
  面试题2
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="书籍" class="dropdown-title"><span class="title">书籍</span> <span class="arrow down"></span></button> <button type="button" aria-label="书籍" class="mobile-dropdown-title"><span class="title">书籍</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          js
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/blog/books/js/es6/" class="nav-link">
  es6
</a></li></ul></li><li class="dropdown-item"><h4>
          web 3D
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="http://www.webgl3d.cn/WebGL/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  webgl
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-subitem"><a href="http://www.webgl3d.cn/Three.js/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  threejs
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></li><li class="dropdown-item"><!----> <a href="/blog/git/" class="nav-link">
  Git
</a></li><li class="dropdown-item"><!----> <a href="/blog/vite/" class="nav-link">
  vite
</a></li></ul></div></div><div class="nav-item"><a href="/blog/api/" class="nav-link">
  API
</a></div><div class="nav-item"><a href="/blog/node/base/01-环境搭建.html" class="nav-link">
  node
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Typescript" class="dropdown-title"><span class="title">Typescript</span> <span class="arrow down"></span></button> <button type="button" aria-label="Typescript" class="mobile-dropdown-title"><span class="title">Typescript</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/typescript/base.html" class="nav-link">
  基础
</a></li><li class="dropdown-item"><!----> <a href="/blog/typescript/challenge.html" class="nav-link">
  高级api
</a></li></ul></div></div><div class="nav-item"><a href="/blog/other/resource-analysis/vue2.html" class="nav-link">
  other
</a></div><div class="nav-item"><a href="https://github.com/tjw-javen/blog" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>深入浅出 Vue3</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Vue3 plain</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>浏览器</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>算法基础</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>前端基础</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>书籍</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>javascript</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>react</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>node</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/other/node/koa2.html" class="sidebar-link">koa2</a></li><li><a href="/blog/other/node/node.html" aria-current="page" class="active sidebar-link">node</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#require-id" class="sidebar-link">require(id)</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#module-exports" class="sidebar-link">module.exports</a></li><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#json-文件" class="sidebar-link">JSON 文件</a></li><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#加载大文件" class="sidebar-link">加载大文件</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#module-exports-和-exports" class="sidebar-link">module.exports 和 exports</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#执行时" class="sidebar-link">执行时</a></li><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#exports" class="sidebar-link">exports</a></li><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#使用" class="sidebar-link">使用</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#路径变量" class="sidebar-link">路径变量</a></li><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#console" class="sidebar-link">console</a></li><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#process" class="sidebar-link">process</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#查看-path" class="sidebar-link">查看 PATH</a></li><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#设置-path" class="sidebar-link">设置 PATH</a></li><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#获取信息" class="sidebar-link">获取信息</a></li><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#nexttick" class="sidebar-link">nextTick</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#tostring" class="sidebar-link">toString</a></li><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#data-uri" class="sidebar-link">data URI</a></li><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#promisify" class="sidebar-link">promisify</a></li><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#理解流" class="sidebar-link">理解流</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#流的类型" class="sidebar-link">流的类型</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#使用内建流-api" class="sidebar-link">使用内建流 API</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#静态-web-服务器" class="sidebar-link">静态 web 服务器</a></li><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#流的错误处理" class="sidebar-link">流的错误处理</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#使用流基类" class="sidebar-link">使用流基类</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#可读流-json-行解析器" class="sidebar-link">可读流 - JSON 行解析器</a></li><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#可写流-文字变色" class="sidebar-link">可写流 - 文字变色</a></li><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#双工流-接受和转换数据" class="sidebar-link">双工流 - 接受和转换数据</a></li><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#转换流-解析数据" class="sidebar-link">转换流 - 解析数据</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#测试流" class="sidebar-link">测试流</a></li><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#fs-模块交互" class="sidebar-link">fs 模块交互</a></li><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#posix-文件系统" class="sidebar-link">POSIX 文件系统</a></li><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#读写流" class="sidebar-link">读写流</a></li><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#文件监控" class="sidebar-link">文件监控</a></li><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#同步读取与-require" class="sidebar-link">同步读取与 require</a></li><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#文件描述" class="sidebar-link">文件描述</a></li><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#文件锁" class="sidebar-link">文件锁</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#独占标记" class="sidebar-link">独占标记</a></li><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#mkdir-文件锁" class="sidebar-link">mkdir 文件锁</a></li><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#lock-模块实现" class="sidebar-link">lock 模块实现</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#递归文件操作" class="sidebar-link">递归文件操作</a></li><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#监视文件和文件夹" class="sidebar-link">监视文件和文件夹</a></li><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#逐行地读取文件流" class="sidebar-link">逐行地读取文件流</a></li><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#获取本地-ip" class="sidebar-link">获取本地 IP</a></li><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#tcp-客户端" class="sidebar-link">TCP 客户端</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#启动与测试-tcp" class="sidebar-link">启动与测试 TCP</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#udp-客户端" class="sidebar-link">UDP 客户端</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#文件发送服务" class="sidebar-link">文件发送服务</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#http-客户端" class="sidebar-link">HTTP 客户端</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#启动与测试-http" class="sidebar-link">启动与测试 HTTP</a></li><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#重定向" class="sidebar-link">重定向</a></li><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#http-代理" class="sidebar-link">HTTP 代理</a></li><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#封装-request-promise" class="sidebar-link">封装 request-promise</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#dns-请求" class="sidebar-link">DNS 请求</a></li><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#crypto-库加密解密" class="sidebar-link">crypto 库加密解密</a></li><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#发起-http-请求的方法" class="sidebar-link">发起 HTTP 请求的方法</a></li><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#执行外部应用" class="sidebar-link">执行外部应用</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#基本概念" class="sidebar-link">基本概念</a></li><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#execfile" class="sidebar-link">execFile</a></li><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#spawn" class="sidebar-link">spawn</a></li><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#exec" class="sidebar-link">exec</a></li><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#fork" class="sidebar-link">fork</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#常用技巧" class="sidebar-link">常用技巧</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#退出时杀死所有子进程" class="sidebar-link">退出时杀死所有子进程</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#cluster-的理解" class="sidebar-link">Cluster 的理解</a></li><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#单线程问题" class="sidebar-link">单线程问题</a></li><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#node-线程" class="sidebar-link">Node 线程</a></li><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#异步-io" class="sidebar-link">异步 IO</a></li><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#cluster-多进程" class="sidebar-link">cluster 多进程</a></li><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#真-node-多线程" class="sidebar-link">真 Node 多线程</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#线程通信" class="sidebar-link">线程通信</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#多进程-vs-多线程" class="sidebar-link">多进程 vs 多线程</a></li><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#分布式锁" class="sidebar-link">分布式锁</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#数据库的唯一索引" class="sidebar-link">数据库的唯一索引</a></li><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#redis-的-setnx-指令" class="sidebar-link">Redis 的 SETNX 指令</a></li><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#redis-的-redlock-算法" class="sidebar-link">Redis 的 RedLock 算法</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#组件式构建" class="sidebar-link">组件式构建</a></li><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#多环境配置" class="sidebar-link">多环境配置</a></li><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#依赖管理" class="sidebar-link">依赖管理</a></li><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#处理未捕获的异常" class="sidebar-link">处理未捕获的异常</a></li><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#通过-domain-管理异常" class="sidebar-link">通过 domain 管理异常</a></li><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#joi-验证参数" class="sidebar-link">Joi 验证参数</a></li><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#kibana-系统监控" class="sidebar-link">Kibana 系统监控</a></li><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#使用-winston-记录日记" class="sidebar-link">使用 winston 记录日记</a></li><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#委托反向代理" class="sidebar-link">委托反向代理</a></li><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#检测有漏洞的依赖项" class="sidebar-link">检测有漏洞的依赖项</a></li><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#pm2-http-集群配置" class="sidebar-link">PM2 HTTP 集群配置</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#工作线程配置" class="sidebar-link">工作线程配置</a></li><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#pm2-自动启动" class="sidebar-link">PM2 自动启动</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#避免使用-lodash" class="sidebar-link">避免使用 Lodash</a></li><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#benchmark" class="sidebar-link">benchmark</a></li><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#使用-prof-进行性能分析" class="sidebar-link">使用 prof 进行性能分析</a></li><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#使用-headdump-堆快照" class="sidebar-link">使用 headdump 堆快照</a></li><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#helmet-设置安全响应头" class="sidebar-link">helmet 设置安全响应头</a></li><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#使用-security-linter-插件" class="sidebar-link">使用 security-linter 插件</a></li><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#koa-ratelimit-限制并发请求" class="sidebar-link">koa-ratelimit 限制并发请求</a></li><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#纯文本机密信息放置" class="sidebar-link">纯文本机密信息放置</a></li><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#orm-odm-库防止查询注入漏洞" class="sidebar-link">ORM/ODM 库防止查询注入漏洞</a></li><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#使用-bcrypt-代替-crypto" class="sidebar-link">使用 Bcrypt 代替 Crypto</a></li><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#转义-html、js-和-css-输出" class="sidebar-link">转义 HTML、JS 和 CSS 输出</a></li><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#验证传入的-json-schemas" class="sidebar-link">验证传入的 JSON schemas</a></li><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#支持黑名单的-jwt" class="sidebar-link">支持黑名单的 JWT</a></li><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#限制每个用户允许的登录请求" class="sidebar-link">限制每个用户允许的登录请求</a></li><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#使用非-root-用户运行-node-js" class="sidebar-link">使用非 root 用户运行 Node.js</a></li><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#使用反向代理或中间件限制负载大小" class="sidebar-link">使用反向代理或中间件限制负载大小</a></li><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#防止-regex-让-nodejs-过载" class="sidebar-link">防止 RegEx 让 NodeJS 过载</a></li><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#在沙箱中运行不安全代码" class="sidebar-link">在沙箱中运行不安全代码</a></li><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#隐藏客户端的错误详细信息" class="sidebar-link">隐藏客户端的错误详细信息</a></li><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#对-npm-或-yarn-配置-2fa" class="sidebar-link">对 npm 或 Yarn，配置 2FA</a></li><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#session-中间件设置" class="sidebar-link">session 中间件设置</a></li><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#csurf-防止-csrf" class="sidebar-link">csurf 防止 CSRF</a></li><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#watch-服务" class="sidebar-link">watch 服务</a></li><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#restful-web-应用" class="sidebar-link">RESTful web 应用</a></li><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#中间件应用" class="sidebar-link">中间件应用</a></li><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#通过事件组织应用" class="sidebar-link">通过事件组织应用</a></li><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#websocket-与-session" class="sidebar-link">WebSocket 与 session</a></li><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#express4-中间件" class="sidebar-link">Express4 中间件</a></li><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#jwt" class="sidebar-link">JWT</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#跨域认证" class="sidebar-link">跨域认证</a></li><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#jwt-2" class="sidebar-link">JWT</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#koa" class="sidebar-link">koa</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#核心对象" class="sidebar-link">核心对象</a></li><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#源码组成" class="sidebar-link">源码组成</a></li><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#中间件的使用" class="sidebar-link">中间件的使用</a></li><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#返回媒体资源" class="sidebar-link">返回媒体资源</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#web-api-设计" class="sidebar-link">Web API 设计</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#需求" class="sidebar-link">需求</a></li><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#重要准则" class="sidebar-link">重要准则</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#公钥加密私钥解密" class="sidebar-link">公钥加密私钥解密</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#生成公钥私钥" class="sidebar-link">生成公钥私钥</a></li><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#crypto-使用" class="sidebar-link">crypto 使用</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#redis-缓存接口" class="sidebar-link">redis 缓存接口</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#redis-使用" class="sidebar-link">redis 使用</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#node-schedule-使用" class="sidebar-link">node-schedule 使用</a></li><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#跨域共享-cookie" class="sidebar-link">跨域共享 Cookie</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#二级域名共享-cookie" class="sidebar-link">二级域名共享 Cookie</a></li><li class="sidebar-sub-header"><a href="/blog/other/node/node.html#淘宝天猫共享-cookie" class="sidebar-link">淘宝天猫共享 Cookie</a></li></ul></li></ul></li><li><a href="/blog/other/node/NPM.html" class="sidebar-link">NPM</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>node-study</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>other</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>css</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>rxjs</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><p>最近读《重学前端》，开篇就是让你拥有自己的知识体系图谱，后续学的东西补充到相应的模块，既可以加深对原有知识的理解，又可以强化记忆，很不错的学习方案。</p> <p>这篇文章主要知识点来自：</p> <ul><li><a href="https://www.amazon.cn/dp/B01MYX8XG1" target="_blank" rel="noopener noreferrer">《Node.js硬实战：115个核心技巧》<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://github.com/i0natan/nodebestpractices" target="_blank" rel="noopener noreferrer">i0natan/nodebestpractices<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li>后续学习的一些知识点</li></ul> <h1 id="docsify-文档"><a href="#docsify-文档" class="header-anchor">#</a> docsify 文档</h1> <p><a href="https://static.chenng.cn/#/%E5%9F%BA%E7%A1%80-%E5%90%8E%E7%AB%AF/NodeJS" target="_blank" rel="noopener noreferrer">https://static.chenng.cn/#/基础-后端/NodeJS<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h1 id="更新记录"><a href="#更新记录" class="header-anchor">#</a> 更新记录</h1> <p><a href="https://github.com/ringcrl/node-point/commits/master" target="_blank" rel="noopener noreferrer">CHANGE LOG<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h1 id="说明"><a href="#说明" class="header-anchor">#</a> 说明</h1> <p>比较好的 markdown 的查看方式是直接用 VSCode 打开大纲，这样整个脉络一目了然，后续补充知识点也很快定位到相应的位置：</p> <p><img src="https://qiniu.chenng.cn/2019-01-28-09-44-31.png" alt="01.png"></p> <p>这个 markdown 文件已经丢到 Github，有更新会直接推这里：</p> <p>https://github.com/ringcrl/node-point</p> <p>博客上也会记录一些好玩的东西：</p> <p>www.chenng.cn/archives/</p> <h1 id="安装"><a href="#安装" class="header-anchor">#</a> 安装</h1> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment"># 使用 nvm 安装</span>
https://github.com/creationix/nvm<span class="token comment">#install-script # Git install</span>

nvm <span class="token function">install</span>
nvm <span class="token builtin class-name">alias</span> default

<span class="token comment"># 卸载 pkg 安装版</span>
<span class="token function">sudo</span> <span class="token function">rm</span> -rf /usr/local/<span class="token punctuation">{</span>bin/<span class="token punctuation">{</span>node,npm<span class="token punctuation">}</span>,lib/node_modules/npm,lib/node,share/man/*/node.*<span class="token punctuation">}</span>
</code></pre></div><h1 id="全局变量"><a href="#全局变量" class="header-anchor">#</a> 全局变量</h1> <h2 id="require-id"><a href="#require-id" class="header-anchor">#</a> require(id)</h2> <ul><li>内建模块直接从内存加载</li> <li>文件模块通过文件查找定位到文件</li> <li>包通过 package.json 里面的 main 字段查找入口文件</li> <li><a href="https://mp.weixin.qq.com/s?__biz=MzA4MjA1MDM3Ng==&amp;mid=2450827055&amp;idx=1&amp;sn=18606f354f031eea24544929132f53d8&amp;chksm=886bab08bf1c221e28aadfed3d7983ea98e368e390219facca608c8bdf93ec3b71aee8db39cc#rd" target="_blank" rel="noopener noreferrer">require实现模块化<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <h3 id="module-exports"><a href="#module-exports" class="header-anchor">#</a> module.exports</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 通过如下模块包装得到</span>
<span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">exports<span class="token punctuation">,</span> require<span class="token punctuation">,</span> module<span class="token punctuation">,</span> __filename<span class="token punctuation">,</span> __dirname</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 包装头</span>

<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 包装尾</span>
</code></pre></div><h3 id="json-文件"><a href="#json-文件" class="header-anchor">#</a> JSON 文件</h3> <ul><li>通过 <code>fs.readFileSync()</code> 加载</li> <li>通过 <code>JSON.parse()</code> 解析</li></ul> <h3 id="加载大文件"><a href="#加载大文件" class="header-anchor">#</a> 加载大文件</h3> <ul><li>require 成功后会缓存文件</li> <li>大量使用会导致大量数据驻留在内存中，导致 GC 频分和内存泄露</li></ul> <h2 id="module-exports-和-exports"><a href="#module-exports-和-exports" class="header-anchor">#</a> module.exports 和 exports</h2> <h3 id="执行时"><a href="#执行时" class="header-anchor">#</a> 执行时</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">(</span><span class="token function">funciton</span><span class="token punctuation">(</span><span class="token parameter">exports<span class="token punctuation">,</span> require<span class="token punctuation">,</span> module<span class="token punctuation">,</span> __filename<span class="token punctuation">,</span> __dirname</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 包装头</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'hello world!'</span><span class="token punctuation">)</span> <span class="token comment">// 原始文件</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 包装尾</span>
</code></pre></div><h3 id="exports"><a href="#exports" class="header-anchor">#</a> exports</h3> <ul><li>exports 是 module 的属性，默认情况是空对象</li> <li>require 一个模块实际得到的是该模块的 exports 属性</li> <li>exports.xxx 导出具有多个属性的对象</li> <li>module.exports = xxx 导出一个对象</li></ul> <h3 id="使用"><a href="#使用" class="header-anchor">#</a> 使用</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// module-2.js</span>
exports<span class="token punctuation">.</span><span class="token function-variable function">method</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token string">'Hello'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

exports<span class="token punctuation">.</span><span class="token function-variable function">method2</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token string">'Hello again'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// module-1.js</span>
<span class="token keyword">const</span> module2 <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./module-2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>module2<span class="token punctuation">.</span><span class="token function">method</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Hello</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>module2<span class="token punctuation">.</span><span class="token function">method2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Hello again</span>
</code></pre></div><h2 id="路径变量"><a href="#路径变量" class="header-anchor">#</a> 路径变量</h2> <div class="language-js extra-class"><pre class="language-js"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'__dirname:'</span><span class="token punctuation">,</span> __dirname<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 文件夹</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'__filename:'</span><span class="token punctuation">,</span> __filename<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 文件</span>

path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'views'</span><span class="token punctuation">,</span> <span class="token string">'view.html'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 如果不希望自己手动处理 / 的问题，使用 path.join</span>

<span class="token comment">// HOME 目录</span>
<span class="token keyword">const</span> homeDir <span class="token operator">=</span>  <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'os'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">homedir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="console"><a href="#console" class="header-anchor">#</a> console</h2> <table><thead><tr><th style="text-align:center;">占位符</th> <th style="text-align:center;">类型</th> <th style="text-align:center;">例子</th></tr></thead> <tbody><tr><td style="text-align:center;">%s</td> <td style="text-align:center;">String</td> <td style="text-align:center;">console.log('%s', 'value')</td></tr> <tr><td style="text-align:center;">%d</td> <td style="text-align:center;">Number</td> <td style="text-align:center;">console.log('%d', 3.14)</td></tr> <tr><td style="text-align:center;">%j</td> <td style="text-align:center;">JSON</td> <td style="text-align:center;">console.log('%j', {name: 'Chenng'})</td></tr></tbody></table> <h2 id="process"><a href="#process" class="header-anchor">#</a> process</h2> <h3 id="查看-path"><a href="#查看-path" class="header-anchor">#</a> 查看 PATH</h3> <div class="language-js extra-class"><pre class="language-js"><code>node

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">PATH</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="设置-path"><a href="#设置-path" class="header-anchor">#</a> 设置 PATH</h3> <div class="language-js extra-class"><pre class="language-js"><code>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">PATH</span> <span class="token operator">+=</span> <span class="token string">':/a_new_path_to_executables'</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="获取信息"><a href="#获取信息" class="header-anchor">#</a> 获取信息</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 获取平台信息</span>
process<span class="token punctuation">.</span>arch <span class="token comment">// x64</span>
process<span class="token punctuation">.</span>platform <span class="token comment">// darwin</span>

<span class="token comment">// 获取内存使用情况</span>
process<span class="token punctuation">.</span><span class="token function">memoryUsage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 获取命令行参数</span>
process<span class="token punctuation">.</span>argv
</code></pre></div><h3 id="nexttick"><a href="#nexttick" class="header-anchor">#</a> nextTick</h3> <p>process.nextTick 方法允许你把一个回调放在下一次时间轮询队列的头上，这意味着可以用来延迟执行，结果是比 setTimeout 更有效率。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> EventEmitter <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'events'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>EventEmitter<span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">complexOperations</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> events <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EventEmitter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  process<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    events<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'success'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> events<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">complexOperations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'success'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'success!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h1 id="buffer"><a href="#buffer" class="header-anchor">#</a> Buffer</h1> <p>如果没有提供编码格式，文件操作以及很多网络操作就会将数据作为 Buffer 类型返回。</p> <h2 id="tostring"><a href="#tostring" class="header-anchor">#</a> toString</h2> <p>默认转为 <code>UTF-8</code> 格式，还支持 <code>ascii</code>、<code>base64</code> 等。</p> <h2 id="data-uri"><a href="#data-uri" class="header-anchor">#</a> data URI</h2> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 生成 data URI</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> mime <span class="token operator">=</span> <span class="token string">'image/png'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> encoding <span class="token operator">=</span> <span class="token string">'base64'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> base64Data <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>__dirname<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/monkey.png</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>encoding<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> uri <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">data:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>mime<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>encoding<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">,</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>base64Data<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>uri<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// data URI 转文件</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> uri <span class="token operator">=</span> <span class="token string">'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgA...'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> base64Data <span class="token operator">=</span> uri<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> buf <span class="token operator">=</span> <span class="token function">Buffer</span><span class="token punctuation">(</span>base64Data<span class="token punctuation">,</span> <span class="token string">'base64'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
fs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>__dirname<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/secondmonkey.png</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h1 id="events"><a href="#events" class="header-anchor">#</a> events</h1> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> EventEmitter <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'events'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>EventEmitter<span class="token punctuation">;</span>

<span class="token keyword">const</span> AudioDevice <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">play</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">track</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'play'</span><span class="token punctuation">,</span> track<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function-variable function">stop</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'stop'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">MusicPlayer</span> <span class="token keyword">extends</span> <span class="token class-name">EventEmitter</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>playing <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> musicPlayer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MusicPlayer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
musicPlayer<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'play'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">track</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>playing <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  AudioDevice<span class="token punctuation">.</span><span class="token function">play</span><span class="token punctuation">(</span>track<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
musicPlayer<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'stop'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>playing <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  AudioDevice<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

musicPlayer<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'play'</span><span class="token punctuation">,</span> <span class="token string">'The Roots - The Fire'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  musicPlayer<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'stop'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 处理异常</span>
<span class="token comment">// EventEmitter 实例发生错误会发出一个 error 事件</span>
<span class="token comment">// 如果没有监听器，默认动作是打印一个堆栈并退出程序</span>
musicPlayer<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">err</span><span class="token punctuation">(</span><span class="token string">'Error:'</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h1 id="util"><a href="#util" class="header-anchor">#</a> util</h1> <h2 id="promisify"><a href="#promisify" class="header-anchor">#</a> promisify</h2> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> util <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'util'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> readAsync <span class="token operator">=</span> util<span class="token punctuation">.</span><span class="token function">promisify</span><span class="token punctuation">(</span>fs<span class="token punctuation">.</span>readFile<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> data <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">readAsync</span><span class="token punctuation">(</span><span class="token string">'./package.json'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    data  <span class="token operator">=</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>

    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h1 id="流"><a href="#流" class="header-anchor">#</a> 流</h1> <h2 id="理解流"><a href="#理解流" class="header-anchor">#</a> 理解流</h2> <p>流是基于事件的 API，用于管理和处理数据。</p> <ul><li>流是能够读写的</li> <li>是基于事件实现的一个实例</li></ul> <p>理解流的最好方式就是想象一下没有流的时候怎么处理数据：</p> <ul><li><code>fs.readFileSync</code> 同步读取文件，程序会阻塞，所有数据被读到内存</li> <li><code>fs.readFile</code> 阻止程序阻塞，但仍会将文件所有数据读取到内存中</li> <li>希望少内存读取大文件，读取一个数据块到内存处理完再去索取更多的数据</li></ul> <h3 id="流的类型"><a href="#流的类型" class="header-anchor">#</a> 流的类型</h3> <ul><li>内置：许多核心模块都实现了流接口，如 <code>fs.createReadStream</code></li> <li>HTTP：处理网络技术的流</li> <li>解释器：第三方模块 XML、JSON 解释器</li> <li>浏览器：Node 流可以被拓展使用在浏览器</li> <li>Audio：流接口的声音模块</li> <li>RPC（远程调用）：通过网络发送流是进程间通信的有效方式</li> <li>测试：使用流的测试库</li></ul> <h2 id="使用内建流-api"><a href="#使用内建流-api" class="header-anchor">#</a> 使用内建流 API</h2> <h3 id="静态-web-服务器"><a href="#静态-web-服务器" class="header-anchor">#</a> 静态 web 服务器</h3> <p>想要通过网络高效且支持大文件的发送一个文件到一个客户端。</p> <h4 id="不使用流"><a href="#不使用流" class="header-anchor">#</a> 不使用流</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>__dirname<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/index.html</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      res<span class="token punctuation">.</span>statusCode <span class="token operator">=</span> <span class="token number">500</span><span class="token punctuation">;</span>
      res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token function">String</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="使用流"><a href="#使用流" class="header-anchor">#</a> 使用流</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  fs<span class="token punctuation">.</span><span class="token function">createReadStream</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>__dirname<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/index.html</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>更少代码，更加高效</li> <li>提供一个缓冲区发送到客户端</li></ul> <h4 id="使用流-gzip"><a href="#使用流-gzip" class="header-anchor">#</a> 使用流 + gzip</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> zlib <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'zlib'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token string">'content-encoding'</span><span class="token operator">:</span> <span class="token string">'gzip'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  fs<span class="token punctuation">.</span><span class="token function">createReadStream</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>__dirname<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/index.html</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>zlib<span class="token punctuation">.</span><span class="token function">createGzip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="流的错误处理"><a href="#流的错误处理" class="header-anchor">#</a> 流的错误处理</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> stream <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createReadStream</span><span class="token punctuation">(</span><span class="token string">'not-found'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

stream<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'Stack:'</span><span class="token punctuation">,</span> err<span class="token punctuation">.</span>stack<span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'The error raised was:'</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="使用流基类"><a href="#使用流基类" class="header-anchor">#</a> 使用流基类</h2> <h3 id="可读流-json-行解析器"><a href="#可读流-json-行解析器" class="header-anchor">#</a> 可读流 - JSON 行解析器</h3> <p>可读流被用来为 I/O 源提供灵活的 API，也可以被用作解析器：</p> <ul><li>继承自 steam.Readable 类</li> <li>并实现一个 <code>_read(size)</code> 方法</li></ul> <p>json-lines.txt</p> <div class="language- extra-class"><pre class="language-text"><code>{ &quot;position&quot;: 0, &quot;letter&quot;: &quot;a&quot; }
{ &quot;position&quot;: 1, &quot;letter&quot;: &quot;b&quot; }
{ &quot;position&quot;: 2, &quot;letter&quot;: &quot;c&quot; }
{ &quot;position&quot;: 3, &quot;letter&quot;: &quot;d&quot; }
{ &quot;position&quot;: 4, &quot;letter&quot;: &quot;e&quot; }
{ &quot;position&quot;: 5, &quot;letter&quot;: &quot;f&quot; }
{ &quot;position&quot;: 6, &quot;letter&quot;: &quot;g&quot; }
{ &quot;position&quot;: 7, &quot;letter&quot;: &quot;h&quot; }
{ &quot;position&quot;: 8, &quot;letter&quot;: &quot;i&quot; }
{ &quot;position&quot;: 9, &quot;letter&quot;: &quot;j&quot; }
</code></pre></div><p>JSONLineReader.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> stream <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'stream'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> util <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'util'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">JSONLineReader</span> <span class="token keyword">extends</span> <span class="token class-name">stream<span class="token punctuation">.</span>Readable</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_source <span class="token operator">=</span> source<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_foundLineEnd <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_buffer <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>

    source<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'readable'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 所有定制 stream.Readable 类都需要实现 _read 方法</span>
  <span class="token function">_read</span><span class="token punctuation">(</span><span class="token parameter">size</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> chunk<span class="token punctuation">;</span>
    <span class="token keyword">let</span> line<span class="token punctuation">;</span>
    <span class="token keyword">let</span> result<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_buffer<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      chunk <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_source<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>_buffer <span class="token operator">+=</span> chunk<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">const</span> lineIndex <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_buffer<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>lineIndex <span class="token operator">!==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      line <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_buffer<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> lineIndex<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 从 buffer 的开始截取第一行来获取一些文本进行解析</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>line<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        result <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_buffer <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_buffer<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>lineIndex <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'object'</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 当一个 JSON 记录解析出来的时候，触发一个 object 事件</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>util<span class="token punctuation">.</span><span class="token function">inspect</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 将解析好的 SJON 发回内部队列</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_buffer <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_buffer<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> input <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createReadStream</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>__dirname<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/json-lines.txt</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  encoding<span class="token operator">:</span> <span class="token string">'utf8'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> jsonLineReader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JSONLineReader</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 创建一个 JSONLineReader 实例，传递一个文件流给它处理</span>

jsonLineReader<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'object'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'pos:'</span><span class="token punctuation">,</span> obj<span class="token punctuation">.</span>position<span class="token punctuation">,</span> <span class="token string">'- letter:'</span><span class="token punctuation">,</span> obj<span class="token punctuation">.</span>letter<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="可写流-文字变色"><a href="#可写流-文字变色" class="header-anchor">#</a> 可写流 - 文字变色</h3> <p>可写的流可用于输出数据到底层 I/O:</p> <ul><li>继承自 <code>stream.Writable</code></li> <li>实现一个 <code>_write</code> 方法向底层源数据发送数据</li></ul> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">cat</span> json-lines.txt <span class="token operator">|</span> node stram_writable.js
</code></pre></div><p>stram_writable.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> stream <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'stream'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">GreenStream</span> <span class="token keyword">extends</span> <span class="token class-name">stream<span class="token punctuation">.</span>Writable</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">_write</span><span class="token punctuation">(</span><span class="token parameter">chunk<span class="token punctuation">,</span> encoding<span class="token punctuation">,</span> cb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    process<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">\u001b[32m</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>chunk<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\u001b[39m</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

process<span class="token punctuation">.</span>stdin<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">GreenStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="双工流-接受和转换数据"><a href="#双工流-接受和转换数据" class="header-anchor">#</a> 双工流 - 接受和转换数据</h3> <p>双工流允许发送和接受数据：</p> <ul><li>继承自 <code>stream.Duplex</code></li> <li>实现 <code>_read</code> 和 <code>_write</code> 方法</li></ul> <h3 id="转换流-解析数据"><a href="#转换流-解析数据" class="header-anchor">#</a> 转换流 - 解析数据</h3> <p>使用流改变数据为另一种格式，并且高效地管理内存：</p> <ul><li>继承自 <code>stream.Transform</code></li> <li>实现 <code>_transform</code> 方法</li></ul> <h2 id="测试流"><a href="#测试流" class="header-anchor">#</a> 测试流</h2> <p>使用 Node 内置的断言模块测试</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> assert <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'assert'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> CSVParser <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./csvparser'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> parser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CSVParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> actual <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

fs<span class="token punctuation">.</span><span class="token function">createReadStream</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>__dirname<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/sample.csv</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>parser<span class="token punctuation">)</span><span class="token punctuation">;</span>

process<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'exit'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  actual<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>parser<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  actual<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>parser<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  actual<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>parser<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> expected <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">'Alex'</span><span class="token punctuation">,</span> location<span class="token operator">:</span> <span class="token string">'UK'</span><span class="token punctuation">,</span> role<span class="token operator">:</span> <span class="token string">'admin'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">'Sam'</span><span class="token punctuation">,</span> location<span class="token operator">:</span> <span class="token string">'France'</span><span class="token punctuation">,</span> role<span class="token operator">:</span> <span class="token string">'user'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">'John'</span><span class="token punctuation">,</span> location<span class="token operator">:</span> <span class="token string">'Canada'</span><span class="token punctuation">,</span> role<span class="token operator">:</span> <span class="token string">'user'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">;</span>

  assert<span class="token punctuation">.</span><span class="token function">deepEqual</span><span class="token punctuation">(</span>expected<span class="token punctuation">,</span> actual<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h1 id="文件系统"><a href="#文件系统" class="header-anchor">#</a> 文件系统</h1> <h2 id="fs-模块交互"><a href="#fs-模块交互" class="header-anchor">#</a> fs 模块交互</h2> <ul><li>POSIX 文件 I/O</li> <li>文件流</li> <li>批量文件 I/O</li> <li>文件监控</li></ul> <h2 id="posix-文件系统"><a href="#posix-文件系统" class="header-anchor">#</a> POSIX 文件系统</h2> <table><thead><tr><th style="text-align:left;">fs 方法</th> <th style="text-align:left;">描述</th></tr></thead> <tbody><tr><td style="text-align:left;">fs.truncate</td> <td style="text-align:left;">截断或者拓展文件到制定的长度</td></tr> <tr><td style="text-align:left;">fs.ftruncate</td> <td style="text-align:left;">和 truncate 一样，但将文件描述符作为参数</td></tr> <tr><td style="text-align:left;">fs.chown</td> <td style="text-align:left;">改变文件的所有者以及组</td></tr> <tr><td style="text-align:left;">fs.fchown</td> <td style="text-align:left;">和 chown 一样，但将文件描述符作为参数</td></tr> <tr><td style="text-align:left;">fs.lchown</td> <td style="text-align:left;">和 chown 一样，但不解析符号链接</td></tr> <tr><td style="text-align:left;">fs.stat</td> <td style="text-align:left;">获取文件状态</td></tr> <tr><td style="text-align:left;">fs.lstat</td> <td style="text-align:left;">和 stat 一样，但是返回信息是关于符号链接而不是它指向的内容</td></tr> <tr><td style="text-align:left;">fs.fstat</td> <td style="text-align:left;">和 stat 一样，但将文件描述符作为参数</td></tr> <tr><td style="text-align:left;">fs.link</td> <td style="text-align:left;">创建一个硬链接</td></tr> <tr><td style="text-align:left;">fs.symlink</td> <td style="text-align:left;">创建一个软连接</td></tr> <tr><td style="text-align:left;">fs.readlink</td> <td style="text-align:left;">读取一个软连接的值</td></tr> <tr><td style="text-align:left;">fs.realpath</td> <td style="text-align:left;">返回规范的绝对路径名</td></tr> <tr><td style="text-align:left;">fs.unlink</td> <td style="text-align:left;">删除文件</td></tr> <tr><td style="text-align:left;">fs.rmdir</td> <td style="text-align:left;">删除文件目录</td></tr> <tr><td style="text-align:left;">fs.mkdir</td> <td style="text-align:left;">创建文件目录</td></tr> <tr><td style="text-align:left;">fs.readdir</td> <td style="text-align:left;">读取一个文件目录的内容</td></tr> <tr><td style="text-align:left;">fs.close</td> <td style="text-align:left;">关闭一个文件描述符</td></tr> <tr><td style="text-align:left;">fs.open</td> <td style="text-align:left;">打开或者创建一个文件用来读取或者写入</td></tr> <tr><td style="text-align:left;">fs.utimes</td> <td style="text-align:left;">设置文件的读取和修改时间</td></tr> <tr><td style="text-align:left;">fs.futimes</td> <td style="text-align:left;">和 utimes 一样，但将文件描述符作为参数</td></tr> <tr><td style="text-align:left;">fs.fsync</td> <td style="text-align:left;">同步磁盘中的文件数据</td></tr> <tr><td style="text-align:left;">fs.write</td> <td style="text-align:left;">写入数据到一个文件</td></tr> <tr><td style="text-align:left;">fs.read</td> <td style="text-align:left;">读取一个文件的数据</td></tr></tbody></table> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> assert <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'assert'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> fd <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">openSync</span><span class="token punctuation">(</span><span class="token string">'./file.txt'</span><span class="token punctuation">,</span> <span class="token string">'w+'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> writeBuf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Buffer</span><span class="token punctuation">(</span><span class="token string">'some data to write'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
fs<span class="token punctuation">.</span><span class="token function">writeSync</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> writeBuf<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> writeBuf<span class="token punctuation">.</span>length<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> readBuf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Buffer</span><span class="token punctuation">(</span>writeBuf<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
fs<span class="token punctuation">.</span><span class="token function">readSync</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> readBuf<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> writeBuf<span class="token punctuation">.</span>length<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
assert<span class="token punctuation">.</span><span class="token function">equal</span><span class="token punctuation">(</span>writeBuf<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> readBuf<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

fs<span class="token punctuation">.</span><span class="token function">closeSync</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="读写流"><a href="#读写流" class="header-anchor">#</a> 读写流</h2> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> readable <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createReadStream</span><span class="token punctuation">(</span><span class="token string">'./original.txt'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> writeable <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createWriteStream</span><span class="token punctuation">(</span><span class="token string">'./copy.txt'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
readable<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>writeable<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="文件监控"><a href="#文件监控" class="header-anchor">#</a> 文件监控</h2> <p><code>fs.watchFile</code> 比 <code>fs.watch</code> 低效，但更好用。</p> <h2 id="同步读取与-require"><a href="#同步读取与-require" class="header-anchor">#</a> 同步读取与 require</h2> <p>同步 fs 的方法应该在第一次初始化应用的时候使用。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span><span class="token string">'./config.json'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">init</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>require：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span>'<span class="token punctuation">.</span><span class="token operator">/</span>config<span class="token punctuation">.</span>json<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">init</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>模块会被全局缓冲，其他文件也加载并修改，会影响到整个系统加载了此文件的模块</li> <li>可以通过 <code>Object.freeze</code> 来冻结一个对象</li></ul> <h2 id="文件描述"><a href="#文件描述" class="header-anchor">#</a> 文件描述</h2> <p>文件描述是在操作系统中管理的在进程中打开文件所关联的一些数字或者索引。操作系统通过指派一个唯一的整数给每个打开的文件用来查看关于这个文件</p> <table><thead><tr><th>Stream</th> <th>文件描述</th> <th>描述</th></tr></thead> <tbody><tr><td>stdin</td> <td>0</td> <td>标准输入</td></tr> <tr><td>stdout</td> <td>1</td> <td>标准输出</td></tr> <tr><td>stderr</td> <td>2</td> <td>标准错误</td></tr></tbody></table> <p><code>console.log('Log')</code> 是 <code>process.stdout.write('log')</code> 的语法糖。</p> <p>一个文件描述是 open 以及 openSync 方法调用返回的一个数字</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> fd <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">openSync</span><span class="token punctuation">(</span><span class="token string">'myfile'</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> fd <span class="token operator">===</span> <span class="token string">'number'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true</span>
</code></pre></div><h2 id="文件锁"><a href="#文件锁" class="header-anchor">#</a> 文件锁</h2> <p>协同多个进程同时访问一个文件，保证文件的完整性以及数据不能丢失：</p> <ul><li>强制锁（在内核级别执行）</li> <li>咨询锁（非强制，只在涉及到进程订阅了相同的锁机制）
<ul><li><code>node-fs-ext</code> 通过 <code>flock</code> 锁住一个文件</li></ul></li> <li>使用锁文件
<ul><li>进程 A 尝试创建一个锁文件，并且成功了</li> <li>进程 A 已经获得了这个锁，可以修改共享的资源</li> <li>进程 B 尝试创建一个锁文件，但失败了，无法修改共享的资源</li></ul></li></ul> <p>Node 实现锁文件</p> <ul><li>使用独占标记创建锁文件</li> <li>使用 mkdir 创建锁文件</li></ul> <h3 id="独占标记"><a href="#独占标记" class="header-anchor">#</a> 独占标记</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 所有需要打开文件的方法，fs.writeFile、fs.createWriteStream、fs.open 都有一个 x 标记</span>
<span class="token comment">// 这个文件应该已独占打开，若这个文件存在，文件不能被打开</span>
fs<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">'config.lock'</span><span class="token punctuation">,</span> <span class="token string">'wx'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> console<span class="token punctuation">.</span><span class="token function">err</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 最好将当前进程号写进文件锁中</span>
<span class="token comment">// 当有异常的时候就知道最后这个锁的进程</span>
fs<span class="token punctuation">.</span><span class="token function">writeFile</span><span class="token punctuation">(</span>
  <span class="token string">'config.lock'</span><span class="token punctuation">,</span>
  process<span class="token punctuation">.</span>pid<span class="token punctuation">,</span>
  <span class="token punctuation">{</span> flogs<span class="token operator">:</span> <span class="token string">'wx'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="mkdir-文件锁"><a href="#mkdir-文件锁" class="header-anchor">#</a> mkdir 文件锁</h3> <p>独占标记有个问题，可能有些系统不能识别 <code>0_EXCL</code> 标记。另一个方案是把锁文件换成一个目录，PID 可以写入目录中的一个文件。</p> <div class="language-js extra-class"><pre class="language-js"><code>fs<span class="token punctuation">.</span><span class="token function">mkidr</span><span class="token punctuation">(</span><span class="token string">'config.lock'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
  fs<span class="token punctuation">.</span><span class="token function">writeFile</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/config.lock/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>process<span class="token punctuation">.</span>pid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="lock-模块实现"><a href="#lock-模块实现" class="header-anchor">#</a> lock 模块实现</h3> <p>https://github.com/npm/lockfile</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> lockDir <span class="token operator">=</span> <span class="token string">'config.lock'</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> hasLock <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

exports<span class="token punctuation">.</span><span class="token function-variable function">lock</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">cb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 获取锁</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>hasLock<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token comment">// 已经获取了一个锁</span>
  fs<span class="token punctuation">.</span><span class="token function">mkdir</span><span class="token punctuation">(</span>lockDir<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token function">cb</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token comment">// 无法创建锁</span>

    fs<span class="token punctuation">.</span><span class="token function">writeFile</span><span class="token punctuation">(</span>lockDir <span class="token operator">+</span> <span class="token string">'/'</span> <span class="token operator">+</span> process<span class="token punctuation">.</span>pid<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 把 PID写入到目录中以便调试</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span> console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token comment">// 无法写入 PID，继续运行</span>
      hasLock <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token comment">// 锁创建了</span>
      <span class="token keyword">return</span> <span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

exports<span class="token punctuation">.</span><span class="token function-variable function">unlock</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">cb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 解锁方法</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>hasLock<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token comment">// 如果没有需要解开的锁</span>
  fs<span class="token punctuation">.</span><span class="token function">unlink</span><span class="token punctuation">(</span>lockDir <span class="token operator">+</span> <span class="token string">'/'</span> <span class="token operator">+</span> process<span class="token punctuation">.</span>pid<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token function">cb</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    fs<span class="token punctuation">.</span><span class="token function">rmdir</span><span class="token punctuation">(</span>lockDir<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">cb</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
      hasLock <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

process<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'exit'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>hasLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    fs<span class="token punctuation">.</span><span class="token function">unlinkSync</span><span class="token punctuation">(</span>lockDir <span class="token operator">+</span> <span class="token string">'/'</span> <span class="token operator">+</span> process<span class="token punctuation">.</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 如果还有锁，在退出之前同步删除掉</span>
    fs<span class="token punctuation">.</span><span class="token function">rmdirSync</span><span class="token punctuation">(</span>lockDir<span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'removed lock'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="递归文件操作"><a href="#递归文件操作" class="header-anchor">#</a> 递归文件操作</h2> <p>一个线上库：<a href="https://github.com/substack/node-mkdirp" target="_blank" rel="noopener noreferrer">mkdirp<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>递归：要解决我们的问题就要先解决更小的相同的问题。</p> <div class="language- extra-class"><pre class="language-text"><code>dir-a
├── dir-b
│   ├── dir-c
│   │   ├── dir-d
│   │   │   └── file-e.png
│   │   └── file-e.png
│   ├── file-c.js
│   └── file-d.txt
├── file-a.js
└── file-b.txt
</code></pre></div><p>查找模块：<code>find /asset/dir-a -name=&quot;file.*&quot;</code></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">[</span>
  <span class="token string">'dir-a/dir-b/dir-c/dir-d/file-e.png'</span><span class="token punctuation">,</span>
  <span class="token string">'dir-a/dir-b/dir-c/file-e.png'</span><span class="token punctuation">,</span>
  <span class="token string">'dir-a/dir-b/file-c.js'</span><span class="token punctuation">,</span>
  <span class="token string">'dir-a/dir-b/file-d.txt'</span><span class="token punctuation">,</span>
  <span class="token string">'dir-a/file-a.js'</span><span class="token punctuation">,</span>
  <span class="token string">'dir-a/file-b.txt'</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> join <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>join<span class="token punctuation">;</span>

<span class="token comment">// 同步查找</span>
exports<span class="token punctuation">.</span><span class="token function-variable function">findSync</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">nameRe<span class="token punctuation">,</span> startPath</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> results <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token keyword">function</span> <span class="token function">finder</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> files <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readdirSync</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> files<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> fpath <span class="token operator">=</span> <span class="token function">join</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> files<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> stats <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">statSync</span><span class="token punctuation">(</span>fpath<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>stats<span class="token punctuation">.</span><span class="token function">isDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">finder</span><span class="token punctuation">(</span>fpath<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>stats<span class="token punctuation">.</span><span class="token function">isFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> nameRe<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>files<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        results<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>fpath<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token function">finder</span><span class="token punctuation">(</span>startPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> results<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 异步查找</span>
exports<span class="token punctuation">.</span><span class="token function-variable function">find</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">nameRe<span class="token punctuation">,</span> startPath<span class="token punctuation">,</span> cb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// cb 可以传入 console.log，灵活</span>
  <span class="token keyword">const</span> results <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> asyncOps <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 2</span>

  <span class="token keyword">function</span> <span class="token function">finder</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    asyncOps<span class="token operator">++</span><span class="token punctuation">;</span>
    fs<span class="token punctuation">.</span><span class="token function">readdir</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">er<span class="token punctuation">,</span> files</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>er<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token function">cb</span><span class="token punctuation">(</span>er<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

      files<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">file</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> fpath <span class="token operator">=</span> <span class="token function">join</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> file<span class="token punctuation">)</span><span class="token punctuation">;</span>

        asyncOps<span class="token operator">++</span><span class="token punctuation">;</span>
        fs<span class="token punctuation">.</span><span class="token function">stat</span><span class="token punctuation">(</span>fpath<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">er<span class="token punctuation">,</span> stats</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>er<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token function">cb</span><span class="token punctuation">(</span>er<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

          <span class="token keyword">if</span> <span class="token punctuation">(</span>stats<span class="token punctuation">.</span><span class="token function">isDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">finder</span><span class="token punctuation">(</span>fpath<span class="token punctuation">)</span><span class="token punctuation">;</span>

          <span class="token keyword">if</span> <span class="token punctuation">(</span>stats<span class="token punctuation">.</span><span class="token function">isFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> nameRe<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            results<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>fpath<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>

          asyncOps<span class="token operator">--</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>asyncOps <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">cb</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> results<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      asyncOps<span class="token operator">--</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>asyncOps <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">cb</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> results<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">finder</span><span class="token punctuation">(</span>startPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>exports<span class="token punctuation">.</span><span class="token function">findSync</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">file.*</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>__dirname<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/dir-a</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>exports<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">file.*</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>__dirname<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/dir-a</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> console<span class="token punctuation">.</span>log<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="监视文件和文件夹"><a href="#监视文件和文件夹" class="header-anchor">#</a> 监视文件和文件夹</h2> <p>想要监听一个文件或者目录，并在文件更改后执行一个动作。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
fs<span class="token punctuation">.</span><span class="token function">watch</span><span class="token punctuation">(</span><span class="token string">'./watchdir'</span><span class="token punctuation">,</span> console<span class="token punctuation">.</span>log<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 稳定且快</span>
fs<span class="token punctuation">.</span><span class="token function">watchFile</span><span class="token punctuation">(</span><span class="token string">'./watchdir'</span><span class="token punctuation">,</span> console<span class="token punctuation">.</span>log<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 跨平台</span>
</code></pre></div><h2 id="逐行地读取文件流"><a href="#逐行地读取文件流" class="header-anchor">#</a> 逐行地读取文件流</h2> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> readline <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'readline'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> rl <span class="token operator">=</span> readline<span class="token punctuation">.</span><span class="token function">createInterface</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  input<span class="token operator">:</span> fs<span class="token punctuation">.</span><span class="token function">createReadStream</span><span class="token punctuation">(</span><span class="token string">'/etc/hosts'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  crlfDelay<span class="token operator">:</span> <span class="token number">Infinity</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

rl<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'line'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">line</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">cc </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>line<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> extract <span class="token operator">=</span> line<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">(\d+\.\d+\.\d+\.\d+) (.*)</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h1 id="网络"><a href="#网络" class="header-anchor">#</a> 网络</h1> <h2 id="获取本地-ip"><a href="#获取本地-ip" class="header-anchor">#</a> 获取本地 IP</h2> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">get_local_ip</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> interfaces <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'os'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">networkInterfaces</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> IPAdress <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> devName <span class="token keyword">in</span> interfaces<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> iface <span class="token operator">=</span> interfaces<span class="token punctuation">[</span>devName<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> iface<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> alias <span class="token operator">=</span> iface<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>alias<span class="token punctuation">.</span>family <span class="token operator">===</span> <span class="token string">'IPv4'</span> <span class="token operator">&amp;&amp;</span> alias<span class="token punctuation">.</span>address <span class="token operator">!==</span> <span class="token string">'127.0.0.1'</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>alias<span class="token punctuation">.</span>internal<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        IPAdress <span class="token operator">=</span> alias<span class="token punctuation">.</span>address<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> IPAdress<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="tcp-客户端"><a href="#tcp-客户端" class="header-anchor">#</a> TCP 客户端</h2> <p>NodeJS 使用 <code>net</code> 模块创建 TCP 连接和服务。</p> <h3 id="启动与测试-tcp"><a href="#启动与测试-tcp" class="header-anchor">#</a> 启动与测试 TCP</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> assert <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'assert'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> net <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'net'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> clients <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> expectedAssertions <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> server <span class="token operator">=</span> net<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">client</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  clients<span class="token operator">++</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> clientId <span class="token operator">=</span> clients<span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Client connected:'</span><span class="token punctuation">,</span> clientId<span class="token punctuation">)</span><span class="token punctuation">;</span>

  client<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Client disconnected:'</span><span class="token punctuation">,</span> clientId<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  client<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">'Welcome client: '</span> <span class="token operator">+</span> clientId<span class="token punctuation">)</span><span class="token punctuation">;</span>
  client<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8000</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Server started on port 8000'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">runTest</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">runTest</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Tests finished'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      assert<span class="token punctuation">.</span><span class="token function">equal</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> expectedAssertions<span class="token punctuation">)</span><span class="token punctuation">;</span>
      server<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">runTest</span><span class="token punctuation">(</span><span class="token parameter">expectedId<span class="token punctuation">,</span> done</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> client <span class="token operator">=</span> net<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token number">8000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  client<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> expected <span class="token operator">=</span> <span class="token string">'Welcome client: '</span> <span class="token operator">+</span> expectedId<span class="token punctuation">;</span>
    assert<span class="token punctuation">.</span><span class="token function">equal</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> expected<span class="token punctuation">)</span><span class="token punctuation">;</span>
    expectedAssertions<span class="token operator">--</span><span class="token punctuation">;</span>
    client<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  client<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">,</span> done<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="udp-客户端"><a href="#udp-客户端" class="header-anchor">#</a> UDP 客户端</h2> <p>利用 <code>dgram</code> 模块创建数据报 <code>socket</code>，然后利用 <code>socket.send</code> 发送数据。</p> <h3 id="文件发送服务"><a href="#文件发送服务" class="header-anchor">#</a> 文件发送服务</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> dgram <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'dgram'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> port <span class="token operator">=</span> <span class="token number">41230</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> defaultSize <span class="token operator">=</span> <span class="token number">16</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">Client</span><span class="token punctuation">(</span><span class="token parameter">remoteIP</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> inStream <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createReadStream</span><span class="token punctuation">(</span>__filename<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 从当前文件创建可读流</span>
  <span class="token keyword">const</span> socket <span class="token operator">=</span> dgram<span class="token punctuation">.</span><span class="token function">createSocket</span><span class="token punctuation">(</span><span class="token string">'udp4'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 创建新的数据流 socket 作为客户端</span>

  inStream<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'readable'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">sendData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 当可读流准备好，开始发送数据到服务器</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">function</span> <span class="token function">sendData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> message <span class="token operator">=</span> inStream<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>defaultSize<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 读取数据块</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>message<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> socket<span class="token punctuation">.</span><span class="token function">unref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 客户端完成任务后，使用 unref 安全关闭它</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 发送数据到服务器</span>
    socket<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> message<span class="token punctuation">.</span>length<span class="token punctuation">,</span> port<span class="token punctuation">,</span> remoteIP<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">sendData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">Server</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> socket <span class="token operator">=</span> dgram<span class="token punctuation">.</span><span class="token function">createSocket</span><span class="token punctuation">(</span><span class="token string">'udp4'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 创建一个 socket 提供服务</span>

  socket<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">msg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    process<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  socket<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'listening'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Server ready:'</span><span class="token punctuation">,</span> socket<span class="token punctuation">.</span><span class="token function">address</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">socket</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'client'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 根据命令行选项确定运行客户端还是服务端</span>
  <span class="token keyword">new</span> <span class="token class-name">Client</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  <span class="token keyword">new</span> <span class="token class-name">Server</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="http-客户端"><a href="#http-客户端" class="header-anchor">#</a> HTTP 客户端</h2> <p>使用 <code>http.createServer</code> 和 <code>http.createClient</code> 运行 HTTP 服务。</p> <h3 id="启动与测试-http"><a href="#启动与测试-http" class="header-anchor">#</a> 启动与测试 HTTP</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> assert <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'assert'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> server <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token string">'Content-Type'</span><span class="token operator">:</span> <span class="token string">'text/plain'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 写入基于文本的响应头</span>
  res<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">'Hello, world.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 发送消息回客户端</span>
  res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8000</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Listening on port 8000'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> req <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">{</span> port<span class="token operator">:</span> <span class="token number">8000</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 创建请求</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'HTTP headers:'</span><span class="token punctuation">,</span> res<span class="token punctuation">.</span>headers<span class="token punctuation">)</span><span class="token punctuation">;</span>
  res<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 给 data 事件创建监听，确保和期望值一致</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Body:'</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    assert<span class="token punctuation">.</span><span class="token function">equal</span><span class="token punctuation">(</span><span class="token string">'Hello, world.'</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    assert<span class="token punctuation">.</span><span class="token function">equal</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> res<span class="token punctuation">.</span>statusCode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    server<span class="token punctuation">.</span><span class="token function">unref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'测试完成'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

req<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="重定向"><a href="#重定向" class="header-anchor">#</a> 重定向</h3> <p>HTTP 标准定义了标识重定向发生时的状态码，它也指出了客户端应该检查无限循环。</p> <ul><li>300：多重选择</li> <li>301：永久移动到新位置</li> <li>302：找到重定向跳转</li> <li>303：参见其他信息</li> <li>304：没有改动</li> <li>305：使用代理</li> <li>307：临时重定向</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> https <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'https'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'url'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 有很多接续 URLs 的方法</span>

<span class="token comment">// 构造函数被用来创建一个对象来构成请求对象的声明周期</span>
<span class="token keyword">function</span> <span class="token function">Request</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>maxRedirects <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>redirects <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token class-name">Request</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">get</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">href<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> uri <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>href<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 解析 URLs 成为 Node http 模块使用的格式，确定是否使用 HTTPS</span>
  <span class="token keyword">const</span> options <span class="token operator">=</span> <span class="token punctuation">{</span> host<span class="token operator">:</span> uri<span class="token punctuation">.</span>host<span class="token punctuation">,</span> path<span class="token operator">:</span> uri<span class="token punctuation">.</span>path <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> httpGet <span class="token operator">=</span> uri<span class="token punctuation">.</span>protocol <span class="token operator">===</span> <span class="token string">'http:'</span> <span class="token operator">?</span> http<span class="token punctuation">.</span>get <span class="token operator">:</span> https<span class="token punctuation">.</span>get<span class="token punctuation">;</span>

  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'GET:'</span><span class="token punctuation">,</span> href<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">function</span> <span class="token function">processResponse</span><span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span>statusCode <span class="token operator">&gt;=</span> <span class="token number">300</span> <span class="token operator">&amp;&amp;</span> response<span class="token punctuation">.</span>statusCode <span class="token operator">&lt;</span> <span class="token number">400</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 检查状态码是否在 HTTP 重定向范围</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>redirects <span class="token operator">&gt;=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>maxRedirects<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>error <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Too many redirects for: '</span> <span class="token operator">+</span> href<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>redirects<span class="token operator">++</span><span class="token punctuation">;</span> <span class="token comment">// 重定向计数自增</span>
        href <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>host<span class="token punctuation">,</span> response<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>location<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 使用 url.resolve 确保相对路径的 URLs 转换为绝对路径 URLs</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>href<span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    response<span class="token punctuation">.</span>url <span class="token operator">=</span> href<span class="token punctuation">;</span>
    response<span class="token punctuation">.</span>redirects <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>redirects<span class="token punctuation">;</span>

    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Redirected:'</span><span class="token punctuation">,</span> href<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">function</span> <span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Connection ended'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>error<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    response<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Got data, length:'</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    response<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">,</span> <span class="token function">end</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 绑定回调到 Request 实例，确保能拿到实例属性</span>
  <span class="token punctuation">}</span>

  <span class="token function">httpGet</span><span class="token punctuation">(</span>options<span class="token punctuation">,</span> <span class="token function">processResponse</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">callback</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
request<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'http://google.com/'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
      Fetched URL: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>res<span class="token punctuation">.</span>url<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> with </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>res<span class="token punctuation">.</span>redirects<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> redirects
    </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="http-代理"><a href="#http-代理" class="header-anchor">#</a> HTTP 代理</h3> <ul><li>ISP 使用透明代理使网络更加高效</li> <li>使用缓存代理服务器减少宽带</li> <li>Web 应用程序的 DevOps 利用他们提升应用程序性能</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'url'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'start request:'</span><span class="token punctuation">,</span> req<span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> options <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
  options<span class="token punctuation">.</span>headers <span class="token operator">=</span> req<span class="token punctuation">.</span>headers<span class="token punctuation">;</span>
  <span class="token keyword">const</span> proxyRequest <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span>options<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">proxyResponse</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 创建请求来复制原始的请求</span>
    proxyResponse<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">chunk</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 监听数据，返回给浏览器</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'proxyResponse length:'</span><span class="token punctuation">,</span> chunk<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
      res<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>chunk<span class="token punctuation">,</span> <span class="token string">'binary'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    proxyResponse<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 追踪代理请求完成</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'proxied request ended'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    res<span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span>proxyResponse<span class="token punctuation">.</span>statusCode<span class="token punctuation">,</span> proxyResponse<span class="token punctuation">.</span>headers<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 发送头部信息给服务器</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  req<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">chunk</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 捕获从浏览器发送到服务器的数据</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'in request length:'</span><span class="token punctuation">,</span> chunk<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
    proxyRequest<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>chunk<span class="token punctuation">,</span> <span class="token string">'binary'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  req<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 追踪原始的请求什么时候结束</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'original request ended'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    proxyRequest<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8888</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 监听来自本地浏览器的连接</span>
</code></pre></div><h3 id="封装-request-promise"><a href="#封装-request-promise" class="header-anchor">#</a> 封装 request-promise</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> https <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'https'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> promisify <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'util'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>promisify<span class="token punctuation">;</span>

https<span class="token punctuation">.</span>get<span class="token punctuation">[</span>promisify<span class="token punctuation">.</span>custom<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">getAsync</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    https<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>options<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      response<span class="token punctuation">.</span>end <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> response<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">,</span> resolve<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> rp <span class="token operator">=</span> <span class="token function">promisify</span><span class="token punctuation">(</span>https<span class="token punctuation">.</span>get<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">rp</span><span class="token punctuation">(</span><span class="token string">'https://jsonmock.hackerrank.com/api/movies/search/?Title=Spiderman&amp;page=1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> body <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
  res<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">chunk</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> body <span class="token operator">+=</span> chunk<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> res<span class="token punctuation">.</span>end<span class="token punctuation">;</span>

  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="dns-请求"><a href="#dns-请求" class="header-anchor">#</a> DNS 请求</h2> <p>使用 <code>dns</code> 模块创建 DNS 请求。</p> <ul><li>A：<code>dns.resolve</code>，A 记录存储 IP 地址</li> <li>TXT：<code>dns.resulveTxt</code>，文本值可以用于在 DNS 上构建其他服务</li> <li>SRV：<code>dns.resolveSrv</code>，服务记录定义服务的定位数据，通常包含主机名和端口号</li> <li>NS：<code>dns.resolveNs</code>，指定域名服务器</li> <li>CNAME：<code>dns.resolveCname</code>，相关的域名记录，设置为域名而不是 IP 地址</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> dns <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'dns'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

dns<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'www.chenng.cn'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> addresses</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Addresses:'</span><span class="token punctuation">,</span> addresses<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="crypto-库加密解密"><a href="#crypto-库加密解密" class="header-anchor">#</a> crypto 库加密解密</h2> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> crypto <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'crypto'</span><span class="token punctuation">)</span>

<span class="token keyword">function</span> <span class="token function">aesEncrypt</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> key <span class="token operator">=</span> <span class="token string">'key'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> cipher <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">createCipher</span><span class="token punctuation">(</span><span class="token string">'aes192'</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span>
  <span class="token keyword">let</span> crypted <span class="token operator">=</span> cipher<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token string">'utf8'</span><span class="token punctuation">,</span> <span class="token string">'hex'</span><span class="token punctuation">)</span>
  crypted <span class="token operator">+=</span> cipher<span class="token punctuation">.</span><span class="token function">final</span><span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> crypted
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">aesDecrypt</span><span class="token punctuation">(</span>encrypted<span class="token punctuation">,</span> key <span class="token operator">=</span> <span class="token string">'key'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> decipher <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">createDecipher</span><span class="token punctuation">(</span><span class="token string">'aes192'</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span>
  <span class="token keyword">let</span> decrypted <span class="token operator">=</span> decipher<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>encrypted<span class="token punctuation">,</span> <span class="token string">'hex'</span><span class="token punctuation">,</span> <span class="token string">'utf8'</span><span class="token punctuation">)</span>
  decrypted <span class="token operator">+=</span> decipher<span class="token punctuation">.</span><span class="token function">final</span><span class="token punctuation">(</span><span class="token string">'utf8'</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> decrypted
<span class="token punctuation">}</span>
</code></pre></div><h2 id="发起-http-请求的方法"><a href="#发起-http-请求的方法" class="header-anchor">#</a> 发起 HTTP 请求的方法</h2> <ul><li>HTTP 标准库
<ul><li>无需安装外部依赖</li> <li>需要以块为单位接受数据，自己监听 end 事件</li> <li>HTTP 和 HTTPS 是两个模块，需要区分使用</li></ul></li> <li>Request 库
<ul><li>使用方便</li> <li>有 promise 版本 <code>request-promise</code></li></ul></li> <li>Axios
<ul><li>既可以用在浏览器又可以用在 NodeJS</li> <li>可以使用 axios.all 并发多个请求</li></ul></li> <li>SuperAgent
<ul><li>可以链式使用</li></ul></li> <li>node-fetch
<ul><li>浏览器的 fetch 移植过来的</li></ul></li></ul> <h1 id="子进程"><a href="#子进程" class="header-anchor">#</a> 子进程</h1> <h2 id="执行外部应用"><a href="#执行外部应用" class="header-anchor">#</a> 执行外部应用</h2> <h3 id="基本概念"><a href="#基本概念" class="header-anchor">#</a> 基本概念</h3> <ul><li>4个异步方法：exec、execFile、fork、spawn
<ul><li>Node
<ul><li>fork：想将一个 Node 进程作为一个独立的进程来运行的时候使用，是的计算处理和文件描述器脱离 Node 主进程</li></ul></li> <li>非 Node
<ul><li>spawn：处理一些会有很多子进程 I/O 时、进程会有大量输出时使用</li> <li>execFile：只需执行一个外部程序的时候使用，执行速度快，处理用户输入相对安全</li> <li>exec：想直接访问线程的 shell 命令时使用，一定要注意用户输入</li></ul></li></ul></li> <li>3个同步方法：execSync、execFileSync、spawnSync</li> <li>通过 API 创建出来的子进程和父进程没有任何必然联系</li></ul> <h3 id="execfile"><a href="#execfile" class="header-anchor">#</a> execFile</h3> <ul><li>会把输出结果缓存好，通过回调返回最后结果或者异常信息</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> cp <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'child_process'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

cp<span class="token punctuation">.</span><span class="token function">execFile</span><span class="token punctuation">(</span><span class="token string">'echo'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'hello'</span><span class="token punctuation">,</span> <span class="token string">'world'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> stdout<span class="token punctuation">,</span> stderr</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span> console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'stdout: '</span><span class="token punctuation">,</span> stdout<span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'stderr: '</span><span class="token punctuation">,</span> stderr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="spawn"><a href="#spawn" class="header-anchor">#</a> spawn</h3> <ul><li>通过流可以使用有大量数据输出的外部应用，节约内存</li> <li>使用流提高数据响应效率</li> <li>spawn 方法返回一个 I/O 的流接口</li></ul> <h4 id="单一任务"><a href="#单一任务" class="header-anchor">#</a> 单一任务</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> cp <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'child_process'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> child <span class="token operator">=</span> cp<span class="token punctuation">.</span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token string">'echo'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'hello'</span><span class="token punctuation">,</span> <span class="token string">'world'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
child<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> console<span class="token punctuation">.</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
child<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>stdout<span class="token punctuation">)</span><span class="token punctuation">;</span>
child<span class="token punctuation">.</span>stderr<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>stderr<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="多任务串联"><a href="#多任务串联" class="header-anchor">#</a> 多任务串联</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> cp <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'child_process'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> cat <span class="token operator">=</span> cp<span class="token punctuation">.</span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token string">'cat'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'messy.txt'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> sort <span class="token operator">=</span> cp<span class="token punctuation">.</span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token string">'sort'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> uniq <span class="token operator">=</span> cp<span class="token punctuation">.</span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token string">'uniq'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

cat<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>sort<span class="token punctuation">.</span>stdin<span class="token punctuation">)</span><span class="token punctuation">;</span>
sort<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>uniq<span class="token punctuation">.</span>stdin<span class="token punctuation">)</span><span class="token punctuation">;</span>
uniq<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>stdout<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="exec"><a href="#exec" class="header-anchor">#</a> exec</h3> <ul><li>只有一个字符串命令</li> <li>和 shell 一模一样</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> cp <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'child_process'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

cp<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">cat </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>__dirname<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/messy.txt | sort | uniq</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> stdout<span class="token punctuation">,</span> stderr</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>stdout<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="fork"><a href="#fork" class="header-anchor">#</a> fork</h3> <ul><li>fork 方法会开发一个 IPC 通道，不同的 Node 进程进行消息传送</li> <li>一个子进程消耗 30ms 启动时间和 10MB 内存</li> <li>子进程：<code>process.on('message')</code>、<code>process.send()</code></li> <li>父进程：<code>child.on('message')</code>、<code>child.send()</code></li></ul> <h4 id="父子通信"><a href="#父子通信" class="header-anchor">#</a> 父子通信</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// parent.js</span>
<span class="token keyword">const</span> cp <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'child_process'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> child <span class="token operator">=</span> cp<span class="token punctuation">.</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token string">'./child'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> silent<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
child<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'monkeys'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
child<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">message</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'got message from child'</span><span class="token punctuation">,</span> message<span class="token punctuation">,</span> <span class="token keyword">typeof</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
child<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>stdout<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  child<span class="token punctuation">.</span><span class="token function">disconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// child.js</span>
process<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">message</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'got one'</span><span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
  process<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'no pizza'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  process<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  process<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span> my<span class="token operator">:</span> <span class="token string">'object'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  process<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  process<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>process<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="常用技巧"><a href="#常用技巧" class="header-anchor">#</a> 常用技巧</h2> <h3 id="退出时杀死所有子进程"><a href="#退出时杀死所有子进程" class="header-anchor">#</a> 退出时杀死所有子进程</h3> <ul><li>保留对由 spawn 返回的 ChildProcess 对象的引用，并在退出主进程时将其杀死</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> spawn <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'child_process'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>spawn<span class="token punctuation">;</span>
<span class="token keyword">const</span> children <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

process<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'exit'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'killing'</span><span class="token punctuation">,</span> children<span class="token punctuation">.</span>length<span class="token punctuation">,</span> <span class="token string">'child processes'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  children<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">child</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    child<span class="token punctuation">.</span><span class="token function">kill</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

children<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token string">'/bin/sleep'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'10'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
children<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token string">'/bin/sleep'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'10'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
children<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token string">'/bin/sleep'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'10'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="cluster-的理解"><a href="#cluster-的理解" class="header-anchor">#</a> Cluster 的理解</h2> <ul><li>解决 NodeJS 单进程无法充分利用多核 CPU 问题</li> <li>通过 master-cluster 模式可以使得应用更加健壮</li> <li>Cluster 底层是 child_process 模块，除了可以发送普通消息，还可以发送底层对象 <code>TCP</code>、<code>UDP</code> 等</li> <li>TCP 主进程发送到子进程，子进程能根据消息重建出 TCP 连接，Cluster 可以决定 fork 出合适的硬件资源的子进程数</li></ul> <h1 id="node-多线程"><a href="#node-多线程" class="header-anchor">#</a> Node 多线程</h1> <h2 id="单线程问题"><a href="#单线程问题" class="header-anchor">#</a> 单线程问题</h2> <ul><li>对 cpu 利用不足</li> <li>某个未捕获的异常可能会导致整个程序的退出</li></ul> <h2 id="node-线程"><a href="#node-线程" class="header-anchor">#</a> Node 线程</h2> <ul><li>Node 进程占用了 7 个线程</li> <li>Node 中最核心的是 v8 引擎，在 Node 启动后，会创建 v8 的实例，这个实例是多线程的
<ul><li>主线程：编译、执行代码</li> <li>编译/优化线程：在主线程执行的时候，可以优化代码</li> <li>分析器线程：记录分析代码运行时间，为 Crankshaft 优化代码执行提供依据</li> <li>垃圾回收的几个线程</li></ul></li> <li>JavaScript 的执行是单线程的，但 Javascript 的宿主环境，无论是 Node 还是浏览器都是多线程的</li></ul> <h2 id="异步-io"><a href="#异步-io" class="header-anchor">#</a> 异步 IO</h2> <ul><li>Node 中有一些 IO 操作（DNS，FS）和一些 CPU 密集计算（Zlib，Crypto）会启用 Node 的线程池</li> <li>线程池默认大小为 4，可以手动更改线程池默认大小</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">UV_THREADPOOL_SIZE</span> <span class="token operator">=</span> <span class="token number">64</span>
</code></pre></div><h2 id="cluster-多进程"><a href="#cluster-多进程" class="header-anchor">#</a> cluster 多进程</h2> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> cluster <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'cluster'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> numCPUs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'os'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">cpus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>cluster<span class="token punctuation">.</span>isMaster<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">主进程 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>process<span class="token punctuation">.</span>pid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 正在运行</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> numCPUs<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    cluster<span class="token punctuation">.</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  cluster<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'exit'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">worker<span class="token punctuation">,</span> code<span class="token punctuation">,</span> signal</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">工作进程 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>worker<span class="token punctuation">.</span>process<span class="token punctuation">.</span>pid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 已退出</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  <span class="token comment">// 工作进程可以共享任何 TCP 连接。</span>
  <span class="token comment">// 在本例子中，共享的是 HTTP 服务器。</span>
  http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'Hello World'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">工作进程 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>process<span class="token punctuation">.</span>pid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 已启动</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>一共有 9 个进程，其中一个主进程，cpu 个数 x cpu 核数 = 2 x 4 = 8 个 子进程</li> <li>无论 child_process 还是 cluster，都不是多线程模型，而是多进程模型</li> <li>应对单线程问题，通常使用多进程的方式来模拟多线程</li></ul> <h2 id="真-node-多线程"><a href="#真-node-多线程" class="header-anchor">#</a> 真 Node 多线程</h2> <ul><li>Node 10.5.0 的发布，给出了一个实验性质的模块 worker_threads 给 Node 提供真正的多线程能力</li> <li>worker_thread 模块中有 4 个对象和 2 个类
<ul><li>isMainThread: 是否是主线程，源码中是通过 threadId === 0 进行判断的。</li> <li>MessagePort: 用于线程之间的通信，继承自 EventEmitter。</li> <li>MessageChannel: 用于创建异步、双向通信的通道实例。</li> <li>threadId: 线程 ID。</li> <li>Worker: 用于在主线程中创建子线程。第一个参数为 filename，表示子线程执行的入口。</li> <li>parentPort: 在 worker 线程里是表示父进程的 MessagePort 类型的对象，在主线程里为 null</li> <li>workerData: 用于在主进程中向子进程传递数据（data 副本）</li></ul></li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span>
  isMainThread<span class="token punctuation">,</span>
  parentPort<span class="token punctuation">,</span>
  workerData<span class="token punctuation">,</span>
  threadId<span class="token punctuation">,</span>
  MessageChannel<span class="token punctuation">,</span>
  MessagePort<span class="token punctuation">,</span>
  Worker
<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'worker_threads'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">mainThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> worker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Worker</span><span class="token punctuation">(</span>__filename<span class="token punctuation">,</span> <span class="token punctuation">{</span> workerData<span class="token operator">:</span> i <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    worker<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'exit'</span><span class="token punctuation">,</span> <span class="token parameter">code</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">main: worker stopped with exit code </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>code<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    worker<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> <span class="token parameter">msg</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">main: receive </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>msg<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      worker<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span>msg <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">workerThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">worker: workerDate </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>workerData<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  parentPort<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> <span class="token parameter">msg</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">worker: receive </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>msg<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  parentPort<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span>workerData<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>isMainThread<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">mainThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  <span class="token function">workerThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="线程通信"><a href="#线程通信" class="header-anchor">#</a> 线程通信</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> assert <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'assert'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>
  Worker<span class="token punctuation">,</span>
  MessageChannel<span class="token punctuation">,</span>
  MessagePort<span class="token punctuation">,</span>
  isMainThread<span class="token punctuation">,</span>
  parentPort
<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'worker_threads'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>isMainThread<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> worker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Worker</span><span class="token punctuation">(</span>__filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> subChannel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MessageChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  worker<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token punctuation">{</span> hereIsYourPort<span class="token operator">:</span> subChannel<span class="token punctuation">.</span>port1 <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>subChannel<span class="token punctuation">.</span>port1<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  subChannel<span class="token punctuation">.</span>port2<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'received:'</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  parentPort<span class="token punctuation">.</span><span class="token function">once</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span>hereIsYourPort <span class="token keyword">instanceof</span> <span class="token class-name">MessagePort</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    value<span class="token punctuation">.</span>hereIsYourPort<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token string">'the worker is sending this'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    value<span class="token punctuation">.</span>hereIsYourPort<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="多进程-vs-多线程"><a href="#多进程-vs-多线程" class="header-anchor">#</a> 多进程 vs 多线程</h2> <p>进程是资源分配的最小单位，线程是CPU调度的最小单位</p> <h1 id="分布式"><a href="#分布式" class="header-anchor">#</a> 分布式</h1> <h2 id="分布式锁"><a href="#分布式锁" class="header-anchor">#</a> 分布式锁</h2> <ul><li>在单机场景下，可以使用语言的内置锁来实现进程同步</li> <li>在分布式场景下，需要同步的进程可能位于不同的节点上，那么就需要使用分布式锁</li></ul> <h3 id="数据库的唯一索引"><a href="#数据库的唯一索引" class="header-anchor">#</a> 数据库的唯一索引</h3> <p>获得锁时向表中插入一条记录，释放锁时删除这条记录。</p> <ul><li>锁没有失效时间，解锁失败的话其它进程无法再获得该锁。</li> <li>只能是非阻塞锁，插入失败直接就报错了，无法重试。</li> <li>不可重入，已经获得锁的进程也必须重新获取锁。</li></ul> <h3 id="redis-的-setnx-指令"><a href="#redis-的-setnx-指令" class="header-anchor">#</a> Redis 的 SETNX 指令</h3> <p>使用 SETNX（set if not exist）指令插入一个键值对，如果 Key 已经存在，那么会返回 False，否则插入成功并返回 True</p> <ul><li>SETNX 指令和数据库的唯一索引类似，保证了只存在一个 Key 的键值对，可以用一个 Key 的键值对是否存在来判断是否存于锁定状态</li> <li>EXPIRE 指令可以为一个键值对设置一个过期时间，从而避免了数据库唯一索引实现方式中释放锁失败的问题</li></ul> <h3 id="redis-的-redlock-算法"><a href="#redis-的-redlock-算法" class="header-anchor">#</a> Redis 的 RedLock 算法</h3> <p>使用了多个 Redis 实例来实现分布式锁，这是为了保证在发生单点故障时仍然可用</p> <ul><li>尝试从 N 个相互独立 Redis 实例获取锁</li> <li>计算获取锁消耗的时间，只有当这个时间小于锁的过期时间，并且从大多数（N / 2 + 1）实例上获取了锁，那么就认为锁获取成功了</li> <li>如果锁获取失败，就到每个实例上释放锁</li></ul> <h1 id="项目管理"><a href="#项目管理" class="header-anchor">#</a> 项目管理</h1> <h2 id="组件式构建"><a href="#组件式构建" class="header-anchor">#</a> 组件式构建</h2> <p>https://github.com/i0natan/nodebestpractices/blob/master/sections/projectstructre/breakintcomponents.chinese.md</p> <h2 id="多环境配置"><a href="#多环境配置" class="header-anchor">#</a> 多环境配置</h2> <ul><li>JSON 配置文件</li> <li>环境变量
使用第三方模块管理（nconf）</li></ul> <h2 id="依赖管理"><a href="#依赖管理" class="header-anchor">#</a> 依赖管理</h2> <ul><li>dependencies：模块正常运行需要的依赖</li> <li>devDependencies：开发时候需要的依赖</li> <li>optionalDependencies：非必要依赖，某种程度上增强</li> <li>peerDependencies：运行时依赖，限定版本</li></ul> <h1 id="异常处理"><a href="#异常处理" class="header-anchor">#</a> 异常处理</h1> <h2 id="处理未捕获的异常"><a href="#处理未捕获的异常" class="header-anchor">#</a> 处理未捕获的异常</h2> <ul><li>除非开发者记得添加.catch语句，在这些地方抛出的错误都不会被 uncaughtException 事件处理程序来处理，然后消失掉。</li> <li>Node 应用不会奔溃，但可能导致内存泄露</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>process<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'uncaughtException'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 我刚收到一个从未被处理的错误</span>
  <span class="token comment">// 现在处理它，并决定是否需要重启应用</span>
  errorManagement<span class="token punctuation">.</span>handler<span class="token punctuation">.</span><span class="token function">handleError</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>errorManagement<span class="token punctuation">.</span>handler<span class="token punctuation">.</span><span class="token function">isTrustedError</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

process<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'unhandledRejection'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">reason<span class="token punctuation">,</span> p</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 我刚刚捕获了一个未处理的promise rejection,</span>
  <span class="token comment">// 因为我们已经有了对于未处理错误的后备的处理机制（见下面）</span>
  <span class="token comment">// 直接抛出，让它来处理</span>
  <span class="token keyword">throw</span> reason<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="通过-domain-管理异常"><a href="#通过-domain-管理异常" class="header-anchor">#</a> 通过 domain 管理异常</h2> <ul><li>通过 domain 模块的 create 方法创建实例</li> <li>某个错误已经任何其他错误都会被同一个 error 处理方法处理</li> <li>任何在这个回调中导致错误的代码都会被 domain 覆盖到</li> <li>允许我们代码在一个沙盒运行，并且可以使用 res 对象给用户反馈</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> domain <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'domain'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> audioDomain <span class="token operator">=</span> domain<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

audioDomain<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'audioDomain error:'</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

audioDomain<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> musicPlayer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MusicPlayer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  musicPlayer<span class="token punctuation">.</span><span class="token function">play</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="joi-验证参数"><a href="#joi-验证参数" class="header-anchor">#</a> Joi 验证参数</h2> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> memberSchema <span class="token operator">=</span> Joi<span class="token punctuation">.</span><span class="token function">object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
 password<span class="token operator">:</span> Joi<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">regex</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^[a-zA-Z0-9]{3,30}$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
 birthyear<span class="token operator">:</span> Joi<span class="token punctuation">.</span><span class="token function">number</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">integer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span><span class="token number">1900</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">2013</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
 email<span class="token operator">:</span> Joi<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">email</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
<span class="token keyword">function</span> <span class="token function">addNewMember</span><span class="token punctuation">(</span><span class="token parameter">newMember</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token comment">//assertions come first</span>
 Joi<span class="token punctuation">.</span><span class="token function">assert</span><span class="token punctuation">(</span>newMember<span class="token punctuation">,</span> memberSchema<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//throws if validation fails</span>
 
 <span class="token comment">//other logic here</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="kibana-系统监控"><a href="#kibana-系统监控" class="header-anchor">#</a> Kibana 系统监控</h2> <p>https://github.com/i0natan/nodebestpractices/blob/master/sections/production/smartlogging.chinese.md</p> <h1 id="上线实践"><a href="#上线实践" class="header-anchor">#</a> 上线实践</h1> <h2 id="使用-winston-记录日记"><a href="#使用-winston-记录日记" class="header-anchor">#</a> 使用 winston 记录日记</h2> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> winston <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'winston'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> moment <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'moment'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> logger <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token punctuation">(</span>winston<span class="token punctuation">.</span>Logger<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  transports<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token keyword">new</span> <span class="token punctuation">(</span>winston<span class="token punctuation">.</span>transports<span class="token punctuation">.</span>Console<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token function-variable function">timestamp</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">moment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">'YYYY-MM-DD HH:mm:ss'</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token function-variable function">formatter</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">params</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> time <span class="token operator">=</span> params<span class="token punctuation">.</span><span class="token function">timestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 时间</span>
        <span class="token keyword">let</span> message <span class="token operator">=</span> params<span class="token punctuation">.</span>message <span class="token comment">// 手动信息</span>
        <span class="token keyword">let</span> meta <span class="token operator">=</span> params<span class="token punctuation">.</span>meta <span class="token operator">&amp;&amp;</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>params<span class="token punctuation">.</span>meta<span class="token punctuation">)</span><span class="token punctuation">.</span>length <span class="token operator">?</span> <span class="token string">'\n\t'</span><span class="token operator">+</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>params<span class="token punctuation">.</span>meta<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token string">''</span>
        <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>time<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>message<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">new</span> <span class="token punctuation">(</span>winston<span class="token punctuation">.</span>transports<span class="token punctuation">.</span>File<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      filename<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>__dirname<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/../winston/winston.log</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
      json<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      <span class="token function-variable function">timestamp</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">moment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">'YYYY-MM-DD HH:mm:ss'</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token function-variable function">formatter</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">params</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> time <span class="token operator">=</span> params<span class="token punctuation">.</span><span class="token function">timestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 时间</span>
        <span class="token keyword">let</span> message <span class="token operator">=</span> params<span class="token punctuation">.</span>message <span class="token comment">// 手动信息</span>
        <span class="token keyword">let</span> meta <span class="token operator">=</span> params<span class="token punctuation">.</span>meta <span class="token operator">&amp;&amp;</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>params<span class="token punctuation">.</span>meta<span class="token punctuation">)</span><span class="token punctuation">.</span>length <span class="token operator">?</span> <span class="token string">'\n\t'</span><span class="token operator">+</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>params<span class="token punctuation">.</span>meta<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token string">''</span>
        <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>time<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>message<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> logger

<span class="token comment">// logger.error('error')</span>
<span class="token comment">// logger.warm('warm')</span>
<span class="token comment">// logger.info('info')</span>
</code></pre></div><h2 id="委托反向代理"><a href="#委托反向代理" class="header-anchor">#</a> 委托反向代理</h2> <p>Node 处理 CPU 密集型任务，如 gzipping，SSL termination 等，表现糟糕。相反，使用一个真正的中间件服务像 Nginx 更好。否则可怜的单线程 Node 将不幸地忙于处理网络任务，而不是处理应用程序核心，性能会相应降低。</p> <p>虽然 express.js 通过一些 connect 中间件处理静态文件，但你不应该使用它。Nginx 可以更好地处理静态文件，并可以防止请求动态内容堵塞我们的 node 进程。</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment"># 配置 gzip 压缩</span>
<span class="token function">gzip</span> on<span class="token punctuation">;</span>
gzip_comp_level <span class="token number">6</span><span class="token punctuation">;</span>
gzip_vary on<span class="token punctuation">;</span>

<span class="token comment"># 配置 upstream</span>
upstream myApplication <span class="token punctuation">{</span>
  server <span class="token number">127.0</span>.0.1:3000<span class="token punctuation">;</span>
  server <span class="token number">127.0</span>.0.1:3001<span class="token punctuation">;</span>
  keepalive <span class="token number">64</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">#定义 web server</span>
server <span class="token punctuation">{</span>
  <span class="token comment"># configure server with ssl and error pages</span>
  listen <span class="token number">80</span><span class="token punctuation">;</span>
  listen <span class="token number">443</span> ssl<span class="token punctuation">;</span>
  ssl_certificate /some/location/sillyfacesociety.com.bundle.crt<span class="token punctuation">;</span>
  error_page <span class="token number">502</span> /errors/502.html<span class="token punctuation">;</span>

  <span class="token comment"># handling static content</span>
  location ~ ^/<span class="token punctuation">(</span>images/<span class="token operator">|</span>img/<span class="token operator">|</span>javascript/<span class="token operator">|</span>js/<span class="token operator">|</span>css/<span class="token operator">|</span>stylesheets/<span class="token operator">|</span>flash/<span class="token operator">|</span>media/<span class="token operator">|</span>static/<span class="token operator">|</span>robots.txt<span class="token operator">|</span>humans.txt<span class="token operator">|</span>favicon.ico<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  root /usr/local/silly_face_society/node/public<span class="token punctuation">;</span>
  access_log off<span class="token punctuation">;</span>
  expires max<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="检测有漏洞的依赖项"><a href="#检测有漏洞的依赖项" class="header-anchor">#</a> 检测有漏洞的依赖项</h2> <p>https://docs.npmjs.com/cli/audit</p> <h2 id="pm2-http-集群配置"><a href="#pm2-http-集群配置" class="header-anchor">#</a> PM2 HTTP 集群配置</h2> <h3 id="工作线程配置"><a href="#工作线程配置" class="header-anchor">#</a> 工作线程配置</h3> <ul><li><code>pm2 start app.js -i 4</code>，<code>-i 4</code> 是以 cluster_mode 形式运行 app，有 4 个工作线程，如果配置 <code>0</code>，PM2 会根据 CPU 核心数来生成对应的工作线程</li> <li>工作线程挂了 PM2 会立即将其重启</li> <li><code>pm2 scale &lt;app name&gt; &lt;n&gt;</code> 对集群进行扩展</li></ul> <h3 id="pm2-自动启动"><a href="#pm2-自动启动" class="header-anchor">#</a> PM2 自动启动</h3> <ul><li><code>pm2 save</code> 保存当前运行的应用</li> <li><code>pm2 startup</code> 启动</li></ul> <h1 id="性能实践"><a href="#性能实践" class="header-anchor">#</a> 性能实践</h1> <h2 id="避免使用-lodash"><a href="#避免使用-lodash" class="header-anchor">#</a> 避免使用 Lodash</h2> <ul><li>使用像 lodash 这样的方法库这会导致不必要的依赖和较慢的性能</li> <li>随着新的 V8 引擎和新的 ES 标准的引入，原生方法得到了改进，现在性能比方法库提高了 50%</li></ul> <p>使用 ESLint 插件检测：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
  <span class="token string">&quot;extends&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token string">&quot;plugin:you-dont-need-lodash-underscore/compatible&quot;</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="benchmark"><a href="#benchmark" class="header-anchor">#</a> benchmark</h2> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> _ <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'lodash'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  __ <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'underscore'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  Suite <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'benchmark'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Suite<span class="token punctuation">,</span>
  opts <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./utils'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//cf. https://github.com/Berkmann18/NativeVsUtils/blob/master/utils.js</span>

<span class="token keyword">const</span> concatSuite <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Suite</span><span class="token punctuation">(</span><span class="token string">'concat'</span><span class="token punctuation">,</span> opts<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> array <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

concatSuite<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">'lodash'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> _<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>array<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">'underscore'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> __<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>array<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">'native'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> array<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token string">'async'</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="使用-prof-进行性能分析"><a href="#使用-prof-进行性能分析" class="header-anchor">#</a> 使用 prof 进行性能分析</h2> <ul><li>使用 tick-processor 工具处理分析</li></ul> <div class="language-sh extra-class"><pre class="language-sh"><code>node --prof profile-test.js
</code></pre></div><div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">npm</span> <span class="token function">install</span> tick -g

node-tick-processor
</code></pre></div><h2 id="使用-headdump-堆快照"><a href="#使用-headdump-堆快照" class="header-anchor">#</a> 使用 headdump 堆快照</h2> <ul><li>代码加载模块进行快照文件生成</li> <li>Chrome Profiles 加载快照文件</li></ul> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">yarn</span> <span class="token function">add</span> heapdump -D
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> heapdump <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'heapdump'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> string <span class="token operator">=</span> <span class="token string">'1 string to rule them all'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> leakyArr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> count <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
<span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  leakyArr<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>string<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">1</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> count<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>heapdump<span class="token punctuation">.</span><span class="token function">writeSnapshot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'wrote snapshot'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">20000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h1 id="应用安全清单"><a href="#应用安全清单" class="header-anchor">#</a> 应用安全清单</h1> <h2 id="helmet-设置安全响应头"><a href="#helmet-设置安全响应头" class="header-anchor">#</a> helmet 设置安全响应头</h2> <p>检测头部配置：<a href="https://securityheaders.com/" target="_blank" rel="noopener noreferrer">Security Headers<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <p>应用程序应该使用安全的 header 来防止攻击者使用常见的攻击方式，诸如跨站点脚本攻击(XSS)、跨站请求伪造(CSRF)。可以使用模块 <a href="https://www.npmjs.com/package/helmet" target="_blank" rel="noopener noreferrer">helmet<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 轻松进行配置。</p> <ul><li>构造
<ul><li>X-Frame-Options：sameorigin。提供点击劫持保护，iframe 只能同源。</li></ul></li> <li>传输
<ul><li>Strict-Transport-Security：max-age=31536000; includeSubDomains。强制 HTTPS，这减少了web 应用程序中错误通过 cookies 和外部链接，泄露会话数据，并防止中间人攻击</li></ul></li> <li>内容
<ul><li>X-Content-Type-Options：nosniff。阻止从声明的内容类型中嗅探响应，减少了用户上传恶意内容造成的风险</li> <li>Content-Type：text/html;charset=utf-8。指示浏览器将页面解释为特定的内容类型，而不是依赖浏览器进行假设</li></ul></li> <li>XSS
<ul><li>X-XSS-Protection：1; mode=block。启用了内置于最新 web 浏览器中的跨站点脚本(XSS)过滤器</li></ul></li> <li>下载
<ul><li>X-Download-Options：noopen。</li></ul></li> <li>缓存
<ul><li>Cache-Control：no-cache。web 应中返回的数据可以由用户浏览器以及中间代理缓存。该指令指示他们不要保留页面内容，以免其他人从这些缓存中访问敏感内容</li> <li>Pragma：no-cache。同上</li> <li>Expires：-1。web 响应中返回的数据可以由用户浏览器以及中间代理缓存。该指令通过将到期时间设置为一个值来防止这种情况。</li></ul></li> <li>访问控制
<ul><li>Access-Control-Allow-Origin：not *。'Access-Control-Allow-Origin: *' 默认在现代浏览器中禁用</li> <li>X-Permitted-Cross-Domain-Policies：master-only。指示只有指定的文件在此域中才被视为有效</li></ul></li> <li>内容安全策略
<ul><li>Content-Security-Policy：内容安全策略需要仔细调整并精确定义策略</li></ul></li> <li>服务器信息
<ul><li>Server：不显示。</li></ul></li></ul> <h2 id="使用-security-linter-插件"><a href="#使用-security-linter-插件" class="header-anchor">#</a> 使用 security-linter 插件</h2> <p>使用安全检验插件 <a href="https://github.com/nodesecurity/eslint-plugin-security" target="_blank" rel="noopener noreferrer">eslint-plugin-security<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 或者 <a href="https://www.npmjs.com/package/tslint-config-security" target="_blank" rel="noopener noreferrer">tslint-config-security<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <h2 id="koa-ratelimit-限制并发请求"><a href="#koa-ratelimit-限制并发请求" class="header-anchor">#</a> koa-ratelimit 限制并发请求</h2> <p>DOS 攻击非常流行而且相对容易处理。使用外部服务，比如 cloud 负载均衡, cloud 防火墙, nginx, 或者（对于小的，不是那么重要的app）一个速率限制中间件(比如 <a href="https://github.com/koajs/ratelimit" target="_blank" rel="noopener noreferrer">koa-ratelimit<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>)，来实现速率限制。</p> <h2 id="纯文本机密信息放置"><a href="#纯文本机密信息放置" class="header-anchor">#</a> 纯文本机密信息放置</h2> <p>存储在源代码管理中的机密信息必须进行加密和管理 (滚动密钥(rolling keys)、过期时间、审核等)。使用 pre-commit/push 钩子防止意外提交机密信息。</p> <h2 id="orm-odm-库防止查询注入漏洞"><a href="#orm-odm-库防止查询注入漏洞" class="header-anchor">#</a> ORM/ODM 库防止查询注入漏洞</h2> <p>要防止 SQL/NoSQL 注入和其他恶意攻击, 请始终使用 ORM/ODM 或 database 库来转义数据或支持命名的或索引的参数化查询, 并注意验证用户输入的预期类型。不要只使用 JavaScript 模板字符串或字符串串联将值插入到查询语句中, 因为这会将应用程序置于广泛的漏洞中。</p> <p>库：</p> <ul><li>TypeORM</li> <li>sequelize</li> <li>mongoose</li> <li>Knex</li> <li>Objection.js</li> <li>waterline</li></ul> <h2 id="使用-bcrypt-代替-crypto"><a href="#使用-bcrypt-代替-crypto" class="header-anchor">#</a> 使用 Bcrypt 代替 Crypto</h2> <p>密码或机密信息(API 密钥)应该使用安全的 hash + salt 函数(<a href="https://www.npmjs.com/package/bcrypt" target="_blank" rel="noopener noreferrer">bcrypt<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>)来存储, 因为性能和安全原因, 这应该是其 JavaScript 实现的首选。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 使用10个哈希回合异步生成安全密码</span>
bcrypt<span class="token punctuation">.</span><span class="token function">hash</span><span class="token punctuation">(</span><span class="token string">'myPassword'</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> hash</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 在用户记录中存储安全哈希</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 将提供的密码输入与已保存的哈希进行比较</span>
bcrypt<span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span><span class="token string">'somePassword'</span><span class="token punctuation">,</span> hash<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> match</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>match<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token comment">// 密码匹配</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
   <span class="token comment">// 密码不匹配</span>
  <span class="token punctuation">}</span> 
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="转义-html、js-和-css-输出"><a href="#转义-html、js-和-css-输出" class="header-anchor">#</a> 转义 HTML、JS 和 CSS 输出</h2> <p>发送给浏览器的不受信任数据可能会被执行, 而不是显示, 这通常被称为跨站点脚本(XSS)攻击。使用专用库将数据显式标记为不应执行的纯文本内容(例如:编码、转义)，可以减轻这种问题。</p> <h2 id="验证传入的-json-schemas"><a href="#验证传入的-json-schemas" class="header-anchor">#</a> 验证传入的 JSON schemas</h2> <p>验证传入请求的 body payload，并确保其符合预期要求, 如果没有, 则快速报错。为了避免每个路由中繁琐的验证编码, 您可以使用基于 JSON 的轻量级验证架构，比如 <a href="https://www.npmjs.com/package/jsonschema" target="_blank" rel="noopener noreferrer">jsonschema<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 或 <a href="https://www.npmjs.com/package/joi" target="_blank" rel="noopener noreferrer">joi<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="支持黑名单的-jwt"><a href="#支持黑名单的-jwt" class="header-anchor">#</a> 支持黑名单的 JWT</h2> <p>当使用 JSON Web Tokens(例如, 通过 <a href="https://github.com/jaredhanson/passport" target="_blank" rel="noopener noreferrer">Passport.js<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>), 默认情况下, 没有任何机制可以从发出的令牌中撤消访问权限。一旦发现了一些恶意用户活动, 只要它们持有有效的标记, 就无法阻止他们访问系统。通过实现一个不受信任令牌的黑名单，并在每个请求上验证，来减轻此问题。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> jwt <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express-jwt'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> blacklist <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express-jwt-blacklist'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">jwt</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  secret<span class="token operator">:</span> <span class="token string">'my-secret'</span><span class="token punctuation">,</span>
  isRevoked<span class="token operator">:</span> blacklist<span class="token punctuation">.</span>isRevoked
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/logout'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  blacklist<span class="token punctuation">.</span><span class="token function">revoke</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>user<span class="token punctuation">)</span>
  res<span class="token punctuation">.</span><span class="token function">sendStatus</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="限制每个用户允许的登录请求"><a href="#限制每个用户允许的登录请求" class="header-anchor">#</a> 限制每个用户允许的登录请求</h2> <p>一类保护暴力破解的中间件，比如 express-brute，应该被用在 express 的应用中，来防止暴力/字典攻击；这类攻击主要应用于一些敏感路由，比如 <code>/admin</code> 或者 <code>/login</code>，基于某些请求属性, 如用户名, 或其他标识符, 如正文参数等。否则攻击者可以发出无限制的密码匹配尝试, 以获取对应用程序中特权帐户的访问权限。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> ExpressBrute <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express-brute'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> RedisStore <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express-brute-redis'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> redisStore <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RedisStore</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  host<span class="token operator">:</span> <span class="token string">'127.0.0.1'</span><span class="token punctuation">,</span>
  port<span class="token operator">:</span> <span class="token number">6379</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Start slowing requests after 5 failed </span>
<span class="token comment">// attempts to login for the same user</span>
<span class="token keyword">const</span> loginBruteforce <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ExpressBrute</span><span class="token punctuation">(</span>redisStore<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  freeRetries<span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
  minWait<span class="token operator">:</span> <span class="token number">5</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">,</span> <span class="token comment">// 5 minutes</span>
  maxWait<span class="token operator">:</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">,</span> <span class="token comment">// 1 hour</span>
  failCallback<span class="token operator">:</span> failCallback<span class="token punctuation">,</span>
  handleStoreError<span class="token operator">:</span> handleStoreErrorCallback
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/login'</span><span class="token punctuation">,</span>
  loginBruteforce<span class="token punctuation">.</span><span class="token function">getMiddleware</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token function-variable function">key</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// prevent too many attempts for the same username</span>
      <span class="token function">next</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>body<span class="token punctuation">.</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// error 403 if we hit this route too often</span>
  <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>User<span class="token punctuation">.</span><span class="token function">isValidLogin</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>body<span class="token punctuation">.</span>username<span class="token punctuation">,</span> req<span class="token punctuation">.</span>body<span class="token punctuation">.</span>password<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// reset the failure counter for valid login</span>
      req<span class="token punctuation">.</span>brute<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// logged in</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// handle invalid user</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="使用非-root-用户运行-node-js"><a href="#使用非-root-用户运行-node-js" class="header-anchor">#</a> 使用非 root 用户运行 Node.js</h2> <p>Node.js 作为一个具有无限权限的 root 用户运行，这是一种普遍的情景。例如，在 Docker 容器中，这是默认行为。建议创建一个非 root 用户，并保存到 Docker 镜像中（下面给出了示例），或者通过调用带有&quot;-u username&quot; 的容器来代表此用户运行该进程。否则在服务器上运行脚本的攻击者在本地计算机上获得无限制的权利 (例如，改变 iptable，引流到他的服务器上)</p> <div class="language-dockerfile extra-class"><pre class="language-dockerfile"><code><span class="token instruction"><span class="token keyword">FROM</span> node:latest</span>
<span class="token instruction"><span class="token keyword">COPY</span> package.json .</span>
<span class="token instruction"><span class="token keyword">RUN</span> npm install</span>
<span class="token instruction"><span class="token keyword">COPY</span> . .</span>
<span class="token instruction"><span class="token keyword">EXPOSE</span> 3000</span>
<span class="token instruction"><span class="token keyword">USER</span> node</span>
<span class="token instruction"><span class="token keyword">CMD</span> [<span class="token string">&quot;node&quot;</span>, <span class="token string">&quot;server.js&quot;</span>]</span>
</code></pre></div><h2 id="使用反向代理或中间件限制负载大小"><a href="#使用反向代理或中间件限制负载大小" class="header-anchor">#</a> 使用反向代理或中间件限制负载大小</h2> <p>请求 body 有效载荷越大, Node.js 的单线程就越难处理它。这是攻击者在没有大量请求(DOS/DDOS 攻击)的情况下，就可以让服务器跪下的机会。在边缘上（例如，防火墙，ELB）限制传入请求的 body 大小，或者通过配置 <code>express body parser</code> 仅接收小的载荷，可以减轻这种问题。否则您的应用程序将不得不处理大的请求, 无法处理它必须完成的其他重要工作, 从而导致对 DOS 攻击的性能影响和脆弱性。</p> <p>express：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// body-parser defaults to a body size limit of 300kb</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> limit<span class="token operator">:</span> <span class="token string">'300kb'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 

<span class="token comment">// Request with json body</span>
app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/json'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>

    <span class="token comment">// Check if request payload content-type matches json</span>
    <span class="token comment">// because body-parser does not check for content types</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>req<span class="token punctuation">.</span><span class="token function">is</span><span class="token punctuation">(</span><span class="token string">'json'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">sendStatus</span><span class="token punctuation">(</span><span class="token number">415</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Unsupported media type if request doesn't have JSON body</span>
    <span class="token punctuation">}</span>

    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'Hooray, it worked!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Example app listening on port 3000!'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>nginx：</p> <div class="language- extra-class"><pre class="language-text"><code>http {
    ...
    # Limit the body size for ALL incoming requests to 1 MB
    client_max_body_size 1m;
}

server {
    ...
    # Limit the body size for incoming requests to this specific server block to 1 MB
    client_max_body_size 1m;
}

location /upload {
    ...
    # Limit the body size for incoming requests to this route to 1 MB
    client_max_body_size 1m;
}
</code></pre></div><h2 id="防止-regex-让-nodejs-过载"><a href="#防止-regex-让-nodejs-过载" class="header-anchor">#</a> 防止 RegEx 让 NodeJS 过载</h2> <p>匹配文本的用户输入需要大量的 CPU 周期来处理。在某种程度上，正则处理是效率低下的，比如验证 10 个单词的单个请求可能阻止整个 event loop 长达6秒。由于这个原因，偏向第三方的验证包，比如<a href="https://github.com/chriso/validator.js" target="_blank" rel="noopener noreferrer">validator.js<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，而不是采用正则，或者使用 <a href="https://github.com/substack/safe-regex" target="_blank" rel="noopener noreferrer">safe-regex<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 来检测有问题的正则表达式。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> saferegex <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'safe-regex'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> emailRegex <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^([a-zA-Z0-9])(([\-.]|[_]+)?([a-zA-Z0-9]+))*(@){1}[a-z0-9]+[.]{1}(([a-z]{2,3})|([a-z]{2,3}[.]{1}[a-z]{2,3}))$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">;</span>

<span class="token comment">// should output false because the emailRegex is vulnerable to redos attacks</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">saferegex</span><span class="token punctuation">(</span>emailRegex<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// instead of the regex pattern, use validator:</span>
<span class="token keyword">const</span> validator <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'validator'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>validator<span class="token punctuation">.</span><span class="token function">isEmail</span><span class="token punctuation">(</span><span class="token string">'liran.tal@gmail.com'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="在沙箱中运行不安全代码"><a href="#在沙箱中运行不安全代码" class="header-anchor">#</a> 在沙箱中运行不安全代码</h2> <p>当任务执行在运行时给出的外部代码时(例如, 插件), 使用任何类型的沙盒执行环境保护主代码，并隔离开主代码和插件。这可以通过一个专用的过程来实现 (例如:cluster.fork()), 无服务器环境或充当沙盒的专用 npm 包。</p> <ul><li>一个专门的子进程 - 这提供了一个快速的信息隔离, 但要求制约子进程, 限制其执行时间, 并从错误中恢复</li> <li>一个基于云的无服务框架满足所有沙盒要求，但动态部署和调用Faas方法不是本部分的内容</li> <li>一些 npm 库，比如 <a href="https://www.npmjs.com/package/sandbox" target="_blank" rel="noopener noreferrer">sandbox<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 和 <a href="https://www.npmjs.com/package/vm2" target="_blank" rel="noopener noreferrer">vm2<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 允许通过一行代码执行隔离代码。尽管后一种选择在简单中获胜, 但它提供了有限的保护。</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> Sandbox <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;sandbox&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> s <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Sandbox</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

s<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span> <span class="token string">&quot;lol)hai&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span> <span class="token parameter">output</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>output<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//output='Synatx error'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Example 4 - Restricted code</span>
s<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span> <span class="token string">&quot;process.platform&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span> <span class="token parameter">output</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>output<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//output=Null</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// Example 5 - Infinite loop</span>
s<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span> <span class="token string">&quot;while (true) {}&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span> <span class="token parameter">output</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>output<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//output='Timeout'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="隐藏客户端的错误详细信息"><a href="#隐藏客户端的错误详细信息" class="header-anchor">#</a> 隐藏客户端的错误详细信息</h2> <p>默认情况下, 集成的 express 错误处理程序隐藏错误详细信息。但是, 极有可能, 您实现自己的错误处理逻辑与自定义错误对象(被许多人认为是最佳做法)。如果这样做, 请确保不将整个 Error 对象返回到客户端, 这可能包含一些敏感的应用程序详细信息。否则敏感应用程序详细信息(如服务器文件路径、使用中的第三方模块和可能被攻击者利用的应用程序的其他内部工作流)可能会从 stack trace 发现的信息中泄露。</p> <div class="language- extra-class"><pre class="language-text"><code>// production error handler
// no stacktraces leaked to user
app.use(function(err, req, res, next) {
    res.status(err.status || 500);
    res.render('error', {
        message: err.message,
        error: {}
    });
});
</code></pre></div><h2 id="对-npm-或-yarn-配置-2fa"><a href="#对-npm-或-yarn-配置-2fa" class="header-anchor">#</a> 对 npm 或 Yarn，配置 2FA</h2> <p>开发链中的任何步骤都应使用 MFA(多重身份验证)进行保护, npm/Yarn 对于那些能够掌握某些开发人员密码的攻击者来说是一个很好的机会。使用开发人员凭据, 攻击者可以向跨项目和服务广泛安装的库中注入恶意代码。甚至可能在网络上公开发布。在 npm 中启用两层身份验证（2-factor-authentication）, 攻击者几乎没有机会改变您的软件包代码。</p> <p>https://itnext.io/eslint-backdoor-what-it-is-and-how-to-fix-the-issue-221f58f1a8c8</p> <h2 id="session-中间件设置"><a href="#session-中间件设置" class="header-anchor">#</a> session 中间件设置</h2> <p>每个 web 框架和技术都有其已知的弱点，告诉攻击者我们使用的 web 框架对他们来说是很大的帮助。使用 session 中间件的默认设置, 可以以类似于 <code>X-Powered-Byheader</code> 的方式向模块和框架特定的劫持攻击公开您的应用。尝试隐藏识别和揭露技术栈的任何内容(例如:Nonde.js, express)。否则可以通过不安全的连接发送cookie, 攻击者可能会使用会话标识来标识web应用程序的基础框架以及特定于模块的漏洞。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// using the express session middleware</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">session</span><span class="token punctuation">(</span><span class="token punctuation">{</span>  
 secret<span class="token operator">:</span> <span class="token string">'youruniquesecret'</span><span class="token punctuation">,</span> <span class="token comment">// secret string used in the signing of the session ID that is stored in the cookie</span>
 name<span class="token operator">:</span> <span class="token string">'youruniquename'</span><span class="token punctuation">,</span> <span class="token comment">// set a unique name to remove the default connect.sid</span>
 cookie<span class="token operator">:</span> <span class="token punctuation">{</span>
   httpOnly<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// minimize risk of XSS attacks by restricting the client from reading the cookie</span>
   secure<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// only send cookie over https</span>
   maxAge<span class="token operator">:</span> <span class="token number">60000</span><span class="token operator">*</span><span class="token number">60</span><span class="token operator">*</span><span class="token number">24</span> <span class="token comment">// set cookie expiry length in ms</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="csurf-防止-csrf"><a href="#csurf-防止-csrf" class="header-anchor">#</a> csurf 防止 CSRF</h2> <p>路由层：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> cookieParser <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'cookie-parser'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token keyword">var</span> csrf <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'csurf'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token keyword">var</span> bodyParser <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'body-parser'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token keyword">var</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 设置路由中间件</span>
<span class="token keyword">var</span> csrfProtection <span class="token operator">=</span> <span class="token function">csrf</span><span class="token punctuation">(</span><span class="token punctuation">{</span> cookie<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token keyword">var</span> parseForm <span class="token operator">=</span> bodyParser<span class="token punctuation">.</span><span class="token function">urlencoded</span><span class="token punctuation">(</span><span class="token punctuation">{</span> extended<span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 我们需要这个，因为在 csrfProtection 中 “cookie” 是正确的</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">cookieParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/form'</span><span class="token punctuation">,</span> csrfProtection<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  
  <span class="token comment">// 将 CSRFToken 传递给视图</span>
  res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'send'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> csrfToken<span class="token operator">:</span> req<span class="token punctuation">.</span><span class="token function">csrfToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/process'</span><span class="token punctuation">,</span> parseForm<span class="token punctuation">,</span> csrfProtection<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  
  res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'data is being processed'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>展示层：</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>/process<span class="token punctuation">&quot;</span></span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>POST<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>  
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>hidden<span class="token punctuation">&quot;</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>_csrf<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>{{csrfToken}}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>

  Favorite color: <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>text<span class="token punctuation">&quot;</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>favoriteColor<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>submit<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>Submit<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">&gt;</span></span>  
</code></pre></div><h1 id="综合应用"><a href="#综合应用" class="header-anchor">#</a> 综合应用</h1> <h2 id="watch-服务"><a href="#watch-服务" class="header-anchor">#</a> watch 服务</h2> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> exec <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'child_process'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>exec<span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">watch</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> child <span class="token operator">=</span> <span class="token function">exec</span><span class="token punctuation">(</span><span class="token string">'node server.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> watcher <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">watch</span><span class="token punctuation">(</span>__dirname <span class="token operator">+</span> <span class="token string">'/server.js'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'File changed, reloading.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    child<span class="token punctuation">.</span><span class="token function">kill</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    watcher<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">watch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">watch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="restful-web-应用"><a href="#restful-web-应用" class="header-anchor">#</a> RESTful web 应用</h2> <ul><li><p>REST 意思是表征性状态传输</p></li> <li><p>使用正确的 HTTP 方法、URLs 和头部信息来创建语义化 RESTful API</p></li> <li><p>GET /gages：获取</p></li> <li><p>POST /pages：创建</p></li> <li><p>GET /pages/10：获取 pages10</p></li> <li><p>PATCH /pages/10：更新 pages10</p></li> <li><p>PUT /pages/10：替换 pages10</p></li> <li><p>DELETE /pages/10：删除 pages10</p></li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> app<span class="token punctuation">;</span>
<span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> routes <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./routes'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 使用 JSON body 解析</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">methodOverride</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 允许一个查询参数来制定额外的 HTTP 方法</span>

<span class="token comment">// 资源使用的路由</span>
app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/pages'</span><span class="token punctuation">,</span> routes<span class="token punctuation">.</span>pages<span class="token punctuation">.</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/pages/:id'</span><span class="token punctuation">,</span> routes<span class="token punctuation">.</span>pages<span class="token punctuation">.</span>show<span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/pages'</span><span class="token punctuation">,</span> routes<span class="token punctuation">.</span>pages<span class="token punctuation">.</span>create<span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">patch</span><span class="token punctuation">(</span><span class="token string">'/pages/:id'</span><span class="token punctuation">,</span> routes<span class="token punctuation">.</span>pages<span class="token punctuation">.</span>patch<span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">'/pages/:id'</span><span class="token punctuation">,</span> routes<span class="token punctuation">.</span>pages<span class="token punctuation">.</span>update<span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">del</span><span class="token punctuation">(</span><span class="token string">'/pages/:id'</span><span class="token punctuation">,</span> routes<span class="token punctuation">.</span>pages<span class="token punctuation">.</span>remove<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="中间件应用"><a href="#中间件应用" class="header-anchor">#</a> 中间件应用</h2> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> Schema <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'validate'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> xml2json <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'xml2json'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> util <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'util'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> Page <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Schema</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

Page<span class="token punctuation">.</span><span class="token function">path</span><span class="token punctuation">(</span><span class="token string">'title'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token string">'string'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">required</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 数据校验确保页面有标题</span>

<span class="token keyword">function</span> <span class="token function">ValidatorError</span><span class="token punctuation">(</span><span class="token parameter">errors</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 从错误对象继承，校验出现的错误在错误中间件处理</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>statusCode <span class="token operator">=</span> <span class="token number">400</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>message <span class="token operator">=</span> errors<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">', '</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
util<span class="token punctuation">.</span><span class="token function">inherits</span><span class="token punctuation">(</span>ValidatorError<span class="token punctuation">,</span> Error<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">xmlMiddleware</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 处理 xml 的中间件</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>req<span class="token punctuation">.</span><span class="token function">is</span><span class="token punctuation">(</span><span class="token string">'xml'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">let</span> body <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
  req<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">str</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 从客户端读到数据时触发</span>
    body <span class="token operator">+=</span> str<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  req<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    req<span class="token punctuation">.</span>body <span class="token operator">=</span> xml2json<span class="token punctuation">.</span><span class="token function">toJson</span><span class="token punctuation">(</span>body<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      object<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      sanitize<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">checkValidXml</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 数据校验中间件</span>
  <span class="token keyword">const</span> page <span class="token operator">=</span> Page<span class="token punctuation">.</span><span class="token function">validate</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>body<span class="token punctuation">.</span>page<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>page<span class="token punctuation">.</span>errors<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ValidatorError</span><span class="token punctuation">(</span>page<span class="token punctuation">.</span>errors<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 传递错误给 next 阻止路由继续运行</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">errorHandler</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 错误处理中间件</span>
  console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'errorHandler'</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>
  res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>err<span class="token punctuation">.</span>statusCode <span class="token operator">||</span> <span class="token number">500</span><span class="token punctuation">,</span> err<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>xmlMiddleware<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 应用 XML 中间件到所有的请求中</span>

app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/pages'</span><span class="token punctuation">,</span> checkValidXml<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 特定的请求校验 xml</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Valid page:'</span><span class="token punctuation">,</span> req<span class="token punctuation">.</span>body<span class="token punctuation">.</span>page<span class="token punctuation">)</span><span class="token punctuation">;</span>
  res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>errorHandler<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 添加错误处理中间件</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="通过事件组织应用"><a href="#通过事件组织应用" class="header-anchor">#</a> 通过事件组织应用</h2> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 监听用户注册成功消息，绑定邮件程序</span>
<span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> emails <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./emails'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> routes <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./routes'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/users'</span><span class="token punctuation">,</span> routes<span class="token punctuation">.</span>users<span class="token punctuation">.</span>create<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 设置路由创建用户</span>

app<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'user:created'</span><span class="token punctuation">,</span> emails<span class="token punctuation">.</span>welcome<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 监听创建成功事件，绑定 email 代码</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> app<span class="token punctuation">;</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 用户注册成功发起事件</span>
<span class="token keyword">const</span> User <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./../models/user'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports<span class="token punctuation">.</span><span class="token function-variable function">create</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
  user<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
    res<span class="token punctuation">.</span>app<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'user:created'</span><span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 当用户成功注册时触发创建用户事件</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'User created'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="websocket-与-session"><a href="#websocket-与-session" class="header-anchor">#</a> WebSocket 与 session</h2> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> WebSocketServer <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'ws'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Server<span class="token punctuation">;</span>
<span class="token keyword">const</span> parseCookie <span class="token operator">=</span> express<span class="token punctuation">.</span><span class="token function">cookieParser</span><span class="token punctuation">(</span><span class="token string">'some secret'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 加载解析 cookie 中间件，设置密码</span>
<span class="token keyword">const</span> MemoryStore <span class="token operator">=</span> express<span class="token punctuation">.</span>session<span class="token punctuation">.</span>MemoryStore<span class="token punctuation">;</span> <span class="token comment">// 加载要使用的会话存储</span>
<span class="token keyword">const</span> store <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MemoryStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> server <span class="token operator">=</span> app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">PORT</span> <span class="token operator">||</span> <span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>parseCookie<span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">session</span><span class="token punctuation">(</span><span class="token punctuation">{</span> store<span class="token operator">:</span> store<span class="token punctuation">,</span> secret<span class="token operator">:</span> <span class="token string">'some secret'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 告知 Express 使用会话存储和设置密码(使用 session 中间件)</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">static</span><span class="token punctuation">(</span>__dirname <span class="token operator">+</span> <span class="token string">'/public'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/random'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 测试测试用的会话值</span>
  req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>random <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 设置 WebSocket 服务器，将其传递给 Express 服务器</span>
<span class="token comment">// 需要传递已有的 Express 服务（listen 的返回对象）</span>
<span class="token keyword">const</span> webSocketServer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebSocketServer</span><span class="token punctuation">(</span><span class="token punctuation">{</span> server<span class="token operator">:</span> server <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 在连接事件给客户端创建 WebSocket</span>
webSocketServer<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'connection'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">ws</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> session<span class="token punctuation">;</span>

  ws<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">data<span class="token punctuation">,</span> flags</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> message <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 客户端发送的 JSON，需要一些代码来解析 JSON 字符串确定是否可用</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>message<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'getSession'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">parseCookie</span><span class="token punctuation">(</span>ws<span class="token punctuation">.</span>upgradeReq<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 从 HTTP 的更新请求中获取 WebSocket 的会话 ID</span>
        <span class="token comment">// 一旦 WebSockets 服务器有一个连接，session ID 可以用=从初始化请求中的 cookies 中获取</span>
        <span class="token keyword">const</span> sid <span class="token operator">=</span> ws<span class="token punctuation">.</span>upgradeReq<span class="token punctuation">.</span>signedCookies<span class="token punctuation">[</span><span class="token string">'connect.sid'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token comment">// 从存储中获取用户的会话信息</span>
        <span class="token comment">// 只需要在初始化的请求中传递一个引用给解析 cookie 的中间件</span>
        <span class="token comment">// 然后 session 可以使用 session 存储的 get 方法加载</span>
        store<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>sid<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> loadedSession</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
          session <span class="token operator">=</span> loadedSession<span class="token punctuation">;</span>
          ws<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'session.random: '</span> <span class="token operator">+</span> session<span class="token punctuation">.</span>random<span class="token punctuation">,</span> <span class="token punctuation">{</span>
            mask<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// session 加载后会把一个包含了 session 值的消息发回给客户端</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      ws<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'Unknown command'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-html extra-class"><pre class="language-html"><code><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
    <span class="token keyword">const</span> host <span class="token operator">=</span> window<span class="token punctuation">.</span>document<span class="token punctuation">.</span>location<span class="token punctuation">.</span>host<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">:.*</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> ws <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebSocket</span><span class="token punctuation">(</span><span class="token string">'ws://'</span> <span class="token operator">+</span> host <span class="token operator">+</span> <span class="token string">':3000'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      ws<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'{ &quot;type&quot;: &quot;getSession&quot; }'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 定期向服务器发送消息</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    ws<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> event<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>WebSocket sessions<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>message<span class="token punctuation">'</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h2 id="express4-中间件"><a href="#express4-中间件" class="header-anchor">#</a> Express4 中间件</h2> <table><thead><tr><th>package</th> <th>描述</th></tr></thead> <tbody><tr><td>body-parser</td> <td>解析 URL 编码 和 JSON POST 请求的 body 数据</td></tr> <tr><td>compression</td> <td>压缩服务器响应</td></tr> <tr><td>connect-timeout</td> <td>请求允许超时</td></tr> <tr><td>cookie-parser</td> <td>从 HTTP 头部信息中解析 cookies，结果放在 req.cookies</td></tr> <tr><td>cookie-session</td> <td>使用 cookies 来支持简单会话</td></tr> <tr><td>csurf</td> <td>在会话中添加 token，防御 CSRF 攻击</td></tr> <tr><td>errorhandler</td> <td>Connect 中使用的默认错误处理</td></tr> <tr><td>express-session</td> <td>简单的会话处理，使用 stores 扩展来吧会话信息写入到数据库或文件中</td></tr> <tr><td>method-override</td> <td>映射新的 HTTP 动词到请求变量中的 _method</td></tr> <tr><td>morgan</td> <td>日志格式化</td></tr> <tr><td>response-time</td> <td>跟踪响应时间</td></tr> <tr><td>serve-favicon</td> <td>发送网站图标</td></tr> <tr><td>serve-index</td> <td>目录列表</td></tr> <tr><td>whost</td> <td>允许路由匹配子域名</td></tr></tbody></table> <h2 id="jwt"><a href="#jwt" class="header-anchor">#</a> JWT</h2> <p>JSON Web Token（缩写 JWT）是目前最流行的跨域认证解决方案。</p> <h3 id="跨域认证"><a href="#跨域认证" class="header-anchor">#</a> 跨域认证</h3> <h4 id="一般流程"><a href="#一般流程" class="header-anchor">#</a> 一般流程</h4> <ul><li>用户向服务器发送用户名和密码</li> <li>服务器验证通过后，在当前对话（session）里面保存相关数据，比如用户角色、登录时间等等</li> <li>服务器向用户返回一个 session_id，写入用户的 Cookie</li> <li>用户随后的每一次请求，都会通过 Cookie，将 session_id 传回服务器</li> <li>服务器收到 session_id，找到前期保存的数据，由此得知用户的身份</li></ul> <h4 id="session-共享"><a href="#session-共享" class="header-anchor">#</a> session 共享</h4> <p>在服务器集群，要求 session 数据共享，每台服务器都能够读取 session：</p> <ul><li>一种解决方案是 session 数据持久化，写入数据库或别的持久层。各种服务收到请求后，都向持久层请求数据。这种方案的优点是架构清晰，缺点是工程量比较大。另外，持久层万一挂了，就会单点失败。</li> <li>另一种方案是服务器索性不保存 session 数据了，所有数据都保存在客户端，每次请求都发回服务器。JWT 就是这种方案的一个代表。</li></ul> <h3 id="jwt-2"><a href="#jwt-2" class="header-anchor">#</a> JWT</h3> <h4 id="原理"><a href="#原理" class="header-anchor">#</a> 原理</h4> <ul><li>服务器认证以后，生成一个 JSON 对象，发回给用户</li> <li>用户与服务端通信的时候，都要发回这个 JSON 对象，服务器完全只靠这个对象认定用户身份</li> <li>防止篡改会加上签名</li></ul> <h4 id="数据结构"><a href="#数据结构" class="header-anchor">#</a> 数据结构</h4> <p>Header（头部）.Payload（负载）.Signature（签名）：</p> <ul><li>Header：JSON，使用 Base64 URL 转成字符串</li> <li>Payload：JSON，使用 Base64 URL 转成字符串</li> <li>Signature：对前两部分的签名</li></ul> <h5 id="header"><a href="#header" class="header-anchor">#</a> Header</h5> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
  <span class="token string">&quot;alg&quot;</span><span class="token operator">:</span> <span class="token string">&quot;HS256&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 签名的算法</span>
  <span class="token string">&quot;typ&quot;</span><span class="token operator">:</span> <span class="token string">&quot;JWT&quot;</span> <span class="token comment">// token 的类型</span>
<span class="token punctuation">}</span>
</code></pre></div><h5 id="payload"><a href="#payload" class="header-anchor">#</a> Payload</h5> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
  <span class="token comment">// 7 个官方字段</span>
  <span class="token string">&quot;iss&quot;</span><span class="token operator">:</span> <span class="token string">&quot;签发人&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;exp&quot;</span><span class="token operator">:</span> <span class="token string">&quot;过期时间&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;sub&quot;</span><span class="token operator">:</span> <span class="token string">&quot;主题&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;aud&quot;</span><span class="token operator">:</span> <span class="token string">&quot;受众&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;nbf&quot;</span><span class="token operator">:</span> <span class="token string">&quot;生效时间&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;iat&quot;</span><span class="token operator">:</span> <span class="token string">&quot;签发时间&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;jti&quot;</span><span class="token operator">:</span> <span class="token string">&quot;编号&quot;</span><span class="token punctuation">,</span>
  <span class="token comment">// 定义私有字段</span>
  <span class="token string">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Chenng&quot;</span> 
<span class="token punctuation">}</span>
</code></pre></div><h5 id="signature"><a href="#signature" class="header-anchor">#</a> Signature</h5> <div class="language-sh extra-class"><pre class="language-sh"><code>HMACSHA256<span class="token punctuation">(</span>
  base64UrlEncode<span class="token punctuation">(</span>header<span class="token punctuation">)</span> + <span class="token string">&quot;.&quot;</span> +
  base64UrlEncode<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>,
  secret<span class="token punctuation">)</span> <span class="token comment"># secret 秘钥只有服务器知道</span>
</code></pre></div><h4 id="使用方式"><a href="#使用方式" class="header-anchor">#</a> 使用方式</h4> <ul><li>客户端收到服务器返回的 JWT，可以储存在 Cookie 里面，也可以储存在 localStorage</li> <li>放在 Cookie 里面自动发送，但是这样不能跨域，所以更好的做法是放在 HTTP 请求的头信息 Authorization 字段里面</li></ul> <h4 id="特点"><a href="#特点" class="header-anchor">#</a> 特点</h4> <ul><li>JWT 不仅可以用于认证，也可以用于交换信息。有效使用 JWT，可以降低服务器查询数据库的次数</li> <li>JWT 的最大缺点是，由于服务器不保存 session 状态，因此无法在使用过程中废止某个 token，或者更改 token 的权限。也就是说，一旦 JWT 签发了，在到期之前就会始终有效，除非服务器部署额外的逻辑</li> <li>JWT 本身包含了认证信息，一旦泄露，任何人都可以获得该令牌的所有权限。为了减少盗用，JWT 的有效期应该设置得比较短。对于一些比较重要的权限，使用时应该再次对用户进行认证</li></ul> <h2 id="koa"><a href="#koa" class="header-anchor">#</a> koa</h2> <h3 id="核心对象"><a href="#核心对象" class="header-anchor">#</a> 核心对象</h3> <ul><li>HTTP 接收 解析 响应</li> <li>中间件 执行上下文</li> <li>Koa 中一切的流程都是中间件</li></ul> <h3 id="源码组成"><a href="#源码组成" class="header-anchor">#</a> 源码组成</h3> <ul><li>application</li> <li>context</li> <li>request</li> <li>response</li></ul> <h3 id="中间件的使用"><a href="#中间件的使用" class="header-anchor">#</a> 中间件的使用</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> Koa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">mid1</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">'Hi'</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// next 执行下一个中间件</span>
  ctx<span class="token punctuation">.</span>body <span class="token operator">+=</span> <span class="token string">' there'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token function-variable function">mid2</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  ctx<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">'text/html; chartset=utf-8'</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token function-variable function">mid3</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  ctx<span class="token punctuation">.</span>body <span class="token operator">+=</span> <span class="token string">' chenng'</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>mid1<span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>mid2<span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>mid3<span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">2333</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Hi chenng there</span>
</code></pre></div><h3 id="返回媒体资源"><a href="#返回媒体资源" class="header-anchor">#</a> 返回媒体资源</h3> <div class="language-js extra-class"><pre class="language-js"><code>router
  <span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/api/dynamic_image/codewars'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> axios<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'https://www.codewars.com/users/ringcrl'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span><span class="token punctuation">,</span> kyu<span class="token punctuation">,</span> score<span class="token punctuation">]</span> <span class="token operator">=</span> res<span class="token punctuation">.</span>data
      <span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">&lt;div class=&quot;stat&quot;&gt;&lt;b&gt;Rank:&lt;\/b&gt;(.+?)&lt;\/div&gt;&lt;div class=&quot;stat&quot;&gt;&lt;b&gt;Honor:&lt;\/b&gt;(.+?)&lt;\/div&gt;</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> svg <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
      &lt;svg xmlns=&quot;http://www.w3.org/2000/svg&quot; width=&quot;80&quot; height=&quot;20&quot;&gt;
        &lt;rect x=&quot;0&quot; y=&quot;0&quot; width=&quot;80&quot; height=&quot;20&quot; fill=&quot;#fff&quot; stroke-width=&quot;2&quot; stroke=&quot;#cccccc&quot;&gt;&lt;/rect&gt;
        &lt;rect x=&quot;0&quot; y=&quot;0&quot; width=&quot;50&quot; height=&quot;20&quot; fill=&quot;#5b5b5b&quot;&gt;&lt;/rect&gt;
        &lt;text x=&quot;5&quot; y=&quot;15&quot; class=&quot;small&quot; fill=&quot;#fff&quot; style=&quot;font-size: 14px;&quot;&gt;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>kyu<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/text&gt;
        &lt;rect x=&quot;50&quot; y=&quot;0&quot; width=&quot;30&quot; height=&quot;20&quot; fill=&quot;#3275b0&quot;&gt;&lt;/rect&gt;
        &lt;text x=&quot;53&quot; y=&quot;15&quot; class=&quot;small&quot; fill=&quot;#fff&quot; style=&quot;font-size: 14px&quot;&gt;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>score<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/text&gt;
      &lt;/svg&gt;
    </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'Content-Type'</span><span class="token punctuation">,</span> <span class="token string">'image/svg+xml'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>svg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="web-api-设计"><a href="#web-api-设计" class="header-anchor">#</a> Web API 设计</h2> <h3 id="需求"><a href="#需求" class="header-anchor">#</a> 需求</h3> <ul><li>易于使用</li> <li>便于修改</li> <li>健壮性好</li> <li>不怕公之于众</li></ul> <h3 id="重要准则"><a href="#重要准则" class="header-anchor">#</a> 重要准则</h3> <ul><li>设计容易记忆、功能一目了然</li> <li>使用合适的 HTTP 方法</li> <li>选择合适的英语单词，注意单词的单复数形式</li> <li>使用 OAuth 2.0 进行认证</li></ul> <p>API 通用资源网站 ProgrammableWeb（<a href="http://www.programmableweb.com" target="_blank" rel="noopener noreferrer">http://www.programmableweb.com<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>）中有各种已经公开的 Web API 文档，多观察一下</p> <h2 id="公钥加密私钥解密"><a href="#公钥加密私钥解密" class="header-anchor">#</a> 公钥加密私钥解密</h2> <h3 id="生成公钥私钥"><a href="#生成公钥私钥" class="header-anchor">#</a> 生成公钥私钥</h3> <div class="language- extra-class"><pre class="language-text"><code>利用 openssl 生成公钥私钥 
生成公钥：openssl genrsa -out rsa_private_key.pem 1024 
生成私钥：openssl rsa -in rsa_private_key.pem -pubout -out rsa_public_key.pem
</code></pre></div><h3 id="crypto-使用"><a href="#crypto-使用" class="header-anchor">#</a> crypto 使用</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> crypto <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'crypto'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> publicKey <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>__dirname<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/rsa_public_key.pem</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'ascii'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> privateKey <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>__dirname<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/rsa_private_key.pem</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'ascii'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>publicKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>privateKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token string">'Chenng'</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'content: '</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//公钥加密</span>
<span class="token keyword">const</span> encodeData <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">publicEncrypt</span><span class="token punctuation">(</span>
  publicKey<span class="token punctuation">,</span>
  Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'base64'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'encode: '</span><span class="token punctuation">,</span> encodeData<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//私钥解密</span>
<span class="token keyword">const</span> decodeData <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">privateDecrypt</span><span class="token punctuation">(</span>
  privateKey<span class="token punctuation">,</span>
  Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>encodeData<span class="token punctuation">,</span> <span class="token string">'base64'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'decode: '</span><span class="token punctuation">,</span> decodeData<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="redis-缓存接口"><a href="#redis-缓存接口" class="header-anchor">#</a> redis 缓存接口</h2> <ul><li>部分不用实时更新的数据使用 redis 进行缓存</li> <li>使用 node-schedule 在每晚定时调用接口</li></ul> <h3 id="redis-使用"><a href="#redis-使用" class="header-anchor">#</a> redis 使用</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> redis <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'redis'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> redisClient <span class="token operator">=</span> redis<span class="token punctuation">.</span><span class="token function">createClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> getAsync <span class="token operator">=</span> <span class="token function">promisify</span><span class="token punctuation">(</span>redisClient<span class="token punctuation">.</span>get<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>redisClient<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> codewarsRes <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token keyword">await</span> <span class="token function">getAsync</span><span class="token punctuation">(</span><span class="token string">'codewarsRes'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>codewarsRes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> axios<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'https://www.codewars.com/users/ringcrl'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  codewarsRes <span class="token operator">=</span> res<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
  redisClient<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'codewarsRes'</span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>codewarsRes<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'EX'</span><span class="token punctuation">,</span> <span class="token number">86000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="node-schedule-使用"><a href="#node-schedule-使用" class="header-anchor">#</a> node-schedule 使用</h2> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> schedule <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'node-schedule'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> axios <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'axios'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

schedule<span class="token punctuation">.</span><span class="token function">scheduleJob</span><span class="token punctuation">(</span><span class="token string">'* 23 59 * *'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  axios<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'https://static.chenng.cn/api/dynamic_image/leetcode_problems'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  axios<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'https://static.chenng.cn/api/dynamic_image/leetcode'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  axios<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'https://static.chenng.cn/api/dynamic_image/codewars'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="跨域共享-cookie"><a href="#跨域共享-cookie" class="header-anchor">#</a> 跨域共享 Cookie</h2> <h3 id="二级域名共享-cookie"><a href="#二级域名共享-cookie" class="header-anchor">#</a> 二级域名共享 Cookie</h3> <div class="language-js extra-class"><pre class="language-js"><code>app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">session</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  secret<span class="token operator">:</span> conf<span class="token punctuation">.</span>secret<span class="token punctuation">,</span>
  maxAge<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">3600000</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  cookie<span class="token operator">:</span> <span class="token punctuation">{</span>
    path<span class="token operator">:</span> <span class="token string">'/'</span><span class="token punctuation">,</span>
    domain<span class="token operator">:</span> <span class="token string">'.yourdomain.com'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  store<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">MongoStore</span><span class="token punctuation">(</span>conf<span class="token punctuation">.</span>sessiondb<span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="淘宝天猫共享-cookie"><a href="#淘宝天猫共享-cookie" class="header-anchor">#</a> 淘宝天猫共享 Cookie</h3> <ul><li>淘宝登录后 <code>.taobao.com</code> 的接口会带上 Cookie</li> <li>天猫使用 JSONP 请求一个 <code>.taobao.com</code> 的接口，接口返回一段 script，直接把带有 Cookie 的对象设置到 window 下</li></ul> <h1 id="参考地址"><a href="#参考地址" class="header-anchor">#</a> 参考地址</h1> <ul><li><a href="https://www.amazon.cn/dp/B01MYX8XG1" target="_blank" rel="noopener noreferrer">《Node.js硬实战：115个核心技巧》<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://github.com/i0natan/nodebestpractices" target="_blank" rel="noopener noreferrer">i0natan/nodebestpractices<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://juejin.im/post/5c63b5676fb9a049ac79a798?utm_source=gold_browser_extension" target="_blank" rel="noopener noreferrer">真-Node多线程<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://github.com/CyC2018/CS-Notes" target="_blank" rel="noopener noreferrer">CS-Notes<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">9/6/2022, 10:25:44 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/other/node/koa2.html" class="prev">
        koa2
      </a></span> <span class="next"><a href="/blog/other/node/NPM.html">
        NPM
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/blog/assets/js/app.a9945600.js" defer></script><script src="/blog/assets/js/2.3af135cd.js" defer></script><script src="/blog/assets/js/149.c3b4d241.js" defer></script>
  </body>
</html>
